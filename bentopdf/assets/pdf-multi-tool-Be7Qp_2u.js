import{c as L,i as S}from"./style-CNx3HTbi.js";import{G as ae,H as b,l as V,P as R,e as K,m as re,k as ie,I as se,w as Q,d as X}from"./main-Dqs2Ohqn.js";import{J as le}from"./jszip.min-DMkQATzN.js";import{i as ce}from"./shortcuts-init-C3Q6CKFj.js";import{a as de}from"./repair-pdf-BSxUFwWx.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";ae.workerSrc=new URL("/bentopdf/assets/pdf.worker.min-LyOxJPrg.mjs",import.meta.url).toString();function N(){return Math.random().toString(36).substr(2,9)+Date.now().toString(36)}let l=[],g=new Set,T=[],v=new Set,y=!1,I=!1,B=null;const ge=new Map,$=[],q=[];function p(){const t={allPages:l.map(n=>({...n,canvas:n.canvas})),selectedPages:Array.from(g),splitMarkers:Array.from(v)};$.push(t),q.length=0}function U(t){l=t.allPages.map(n=>({...n,canvas:n.canvas})),g=new Set(t.selectedPages),v=new Set(t.splitMarkers),E()}function w(t,n,e="info"){const o=document.getElementById("modal"),a=document.getElementById("modal-title"),r=document.getElementById("modal-message"),i=document.getElementById("modal-icon");if(!o||!a||!r||!i)return;a.textContent=t,r.textContent=n;const s={info:"info",error:"alert-circle",success:"check-circle"},c={info:"text-blue-400",error:"text-red-400",success:"text-green-400"};i.innerHTML=`<i data-lucide="${s[e]}" class="w-12 h-12 ${c[e]}"></i>`,o.classList.remove("hidden"),L({icons:S})}function _(){const t=document.getElementById("modal");t&&t.classList.add("hidden")}function G(t,n){const e=document.getElementById("loading-overlay"),o=document.getElementById("loading-progress"),a=document.getElementById("loading-text");if(!e||!o||!a)return;e.classList.remove("hidden");const r=Math.round(t/n*100);o.style.width=`${r}%`,a.textContent=b("multiTool.renderingPages")}async function J(t,n){const e=document.getElementById(t);if(!e)return;const o=e.innerHTML,a=e.style.pointerEvents;try{e.disabled=!0,e.style.pointerEvents="none",e.innerHTML='<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>',await n()}finally{e.disabled=!1,e.style.pointerEvents=a,e.innerHTML=o}}function Y(){const t=document.getElementById("loading-overlay");t&&t.classList.add("hidden")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("PDF Multi Tool: DOMContentLoaded"),W()}):(console.log("PDF Multi Tool: DOMContentLoaded already fired, initializing immediately"),W());function W(){console.log("PDF Multi Tool: Initializing..."),L({icons:S}),ce(),document.getElementById("close-tool-btn")?.addEventListener("click",()=>{window.location.href="/bentopdf/"}),document.getElementById("upload-pdfs-btn")?.addEventListener("click",()=>{if(console.log("Upload button clicked, isRendering:",y),y){w(b("multiTool.pleaseWait"),b("multiTool.pagesRendering"),"info");return}document.getElementById("pdf-file-input")?.click()}),document.getElementById("pdf-file-input")?.addEventListener("change",ue),document.getElementById("insert-pdf-input")?.addEventListener("change",pe),document.getElementById("bulk-rotate-left-btn")?.addEventListener("click",()=>{y||(p(),Z(-90))}),document.getElementById("bulk-rotate-btn")?.addEventListener("click",()=>{y||(p(),Z(90))}),document.getElementById("bulk-delete-btn")?.addEventListener("click",()=>{y||(p(),he())}),document.getElementById("bulk-duplicate-btn")?.addEventListener("click",()=>{y||(p(),be())}),document.getElementById("bulk-split-btn")?.addEventListener("click",()=>{y||(p(),ve())}),document.getElementById("bulk-download-btn")?.addEventListener("click",()=>{if(!y&&!y){if(g.size===0){w(b("multiTool.noPagesSelected"),b("multiTool.selectOnePage"),"info");return}J("bulk-download-btn",async()=>{await oe(Array.from(g).sort((n,e)=>n-e),"selected-pages.pdf")})}}),document.getElementById("select-all-btn")?.addEventListener("click",()=>{y||(p(),fe())}),document.getElementById("deselect-all-btn")?.addEventListener("click",()=>{y||(p(),me())}),document.getElementById("export-pdf-btn")?.addEventListener("click",()=>{if(!y&&!y){if(l.length===0){w(b("multiTool.noPages"),b("multiTool.noPagesToExport"),"info");return}J("export-pdf-btn",async()=>{await we()})}}),document.getElementById("add-blank-page-btn")?.addEventListener("click",()=>{y||(p(),ye())}),document.getElementById("undo-btn")?.addEventListener("click",()=>{if(y)return;const n=$.pop();if(n){const e={allPages:l.map(o=>({...o})),selectedPages:Array.from(g),splitMarkers:Array.from(v)};q.push(e),U(n)}}),document.getElementById("redo-btn")?.addEventListener("click",()=>{if(y)return;const n=q.pop();if(n){const e={allPages:l.map(o=>({...o})),selectedPages:Array.from(g),splitMarkers:Array.from(v)};$.push(e),U(n)}}),document.getElementById("reset-btn")?.addEventListener("click",()=>{y?(I=!0,setTimeout(()=>C(),100)):C()}),document.getElementById("modal-close-btn")?.addEventListener("click",_),document.getElementById("modal")?.addEventListener("click",n=>{n.target===document.getElementById("modal")&&_()});const t=document.getElementById("upload-area");t&&(t.addEventListener("dragover",n=>{n.preventDefault(),t.classList.add("border-indigo-500")}),t.addEventListener("dragleave",()=>{t.classList.remove("border-indigo-500")}),t.addEventListener("drop",n=>{n.preventDefault(),t.classList.remove("border-indigo-500");const e=Array.from(n.dataTransfer?.files||[]).filter(o=>o.type==="application/pdf");e.length>0&&ee(e)})),document.getElementById("upload-area")?.classList.remove("hidden")}function C(){I=!0,y=!1,p(),l=[],g.clear(),v.clear(),T=[],ge.clear(),V(),B&&(B.destroy(),B=null);const t=document.getElementById("pages-container");t&&(t.innerHTML=""),E(),document.getElementById("upload-area")?.classList.remove("hidden")}async function ue(t){const n=t.target,e=Array.from(n.files||[]);e.length>0&&await ee(e),n.value=""}async function ee(t){if(y){w(b("multiTool.pleaseWait"),b("multiTool.pagesRendering"),"info");return}const n=document.getElementById("upload-area");n&&n.classList.add("hidden");const e=document.getElementById("pages-container");if(e){y=!0,console.log("PDF Multi Tool: Starting render, isRendering set to true"),I=!1,V(),G(0,100);try{for(const o of t){if(I)break;try{let a;try{console.log(`Repairing ${o.name}...`);const d=document.getElementById("loading-text");d&&(d.textContent=`Repairing ${o.name}...`);const h=await de(o);h?(a=h.buffer,console.log(`Successfully repaired ${o.name} before loading.`)):(console.warn(`Repair returned null for ${o.name}, using original file.`),a=await o.arrayBuffer())}catch(d){console.warn(`Failed to repair ${o.name}, attempting to load original:`,d),a=await o.arrayBuffer()}const r=await R.load(a,{ignoreEncryption:!0,throwOnInvalidObject:!1});T.push(r);const i=T.length-1,s=await r.save(),c=await K({data:new Uint8Array(s)}).promise,f=c.numPages,m=l.length;for(let d=0;d<f;d++)l.push({id:N(),pdfIndex:i,pageIndex:d,rotation:0,visualRotation:0,canvas:null,pdfDoc:r,originalPageIndex:d,fileName:o.name});await re(c,e,(d,h)=>{const P=m+h-1;return l[P]&&(l[P].canvas=d),te(d,P)},{batchSize:8,useLazyLoading:!0,lazyLoadMargin:"400px",onProgress:(d,h)=>{G(d,h)},onBatchComplete:()=>{L({icons:S})},shouldCancel:()=>I})}catch(a){console.error(`Failed to load PDF ${o.name}:`,a),w(b("multiTool.error"),`${b("multiTool.failedToLoad")} ${o.name}.`,"error")}}I||(ne(),L({icons:S}))}finally{Y(),y=!1,console.log("PDF Multi Tool: Render finished/cancelled, isRendering set to false"),I&&(I=!1),l.length===0&&C()}}}function te(t,n){const e=l[n];if(!e)return console.error(`Page data not found for index ${n}`),document.createElement("div");const o=document.createElement("div");o.className="bg-gray-800 rounded-lg border-2 border-gray-700 p-2 relative group cursor-move",o.dataset.pageIndex=n.toString(),o.dataset.pageId=e.id,o.dataset.pageNumber=(e.pageIndex+1).toString(),e.fileName&&(o.dataset.fileName=e.fileName),e.canvas||(o.dataset.lazyLoad="true"),g.has(n)&&o.classList.add("border-indigo-500","ring-2","ring-indigo-500");const a=document.createElement("div");if(a.className="bg-white rounded mb-2 overflow-hidden w-full flex items-center justify-center relative h-36 sm:h-64",t){const u=t;u.className="max-w-full max-h-full object-contain",u.style.transform=`rotate(${e.visualRotation}deg)`,u.style.transition="transform 0.2s ease",a.appendChild(u)}else{const u=document.createElement("div");u.className="flex flex-col items-center justify-center text-gray-400",u.innerHTML=`
      <i data-lucide="loader" class="w-8 h-8 animate-spin mb-2"></i>
      <span class="text-xs">${b("common.loading")}</span>
    `,a.appendChild(u),a.classList.add("bg-gray-700")}const r=document.createElement("div");r.className="text-xs text-gray-400 text-center mb-2",r.textContent=`${b("common.page")} ${n+1}`;const i=document.createElement("div");i.className="flex items-center justify-center gap-1 sm:opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-2 left-0 right-0";const s=document.createElement("div");s.className="flex items-center gap-1 bg-gray-900/90 rounded px-2 py-1",i.appendChild(s);const c=document.createElement("button");c.className="absolute top-2 right-2 p-1 rounded bg-gray-900/70 hover:bg-gray-800 z-10",c.innerHTML=g.has(n)?'<i data-lucide="check-square" class="w-4 h-4 text-indigo-400"></i>':'<i data-lucide="square" class="w-4 h-4 text-gray-200"></i>',c.onclick=u=>{u.stopPropagation(),z(n)};const f=document.createElement("button");f.className="p-1 rounded hover:bg-gray-700",f.innerHTML='<i data-lucide="rotate-cw" class="w-4 h-4 text-gray-300"></i>',f.onclick=u=>{u.stopPropagation(),x(n,90)};const m=document.createElement("button");m.className="p-1 rounded hover:bg-gray-700",m.innerHTML='<i data-lucide="rotate-ccw" class="w-4 h-4 text-gray-300"></i>',m.onclick=u=>{u.stopPropagation(),x(n,-90)};const d=document.createElement("button");d.className="p-1 rounded hover:bg-gray-700",d.innerHTML='<i data-lucide="copy" class="w-4 h-4 text-gray-300"></i>',d.title=b("multiTool.actions.duplicatePage"),d.onclick=u=>{u.stopPropagation(),p(),F(n)};const h=document.createElement("button");h.className="p-1 rounded hover:bg-gray-700",h.innerHTML='<i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i>',h.title=b("multiTool.actions.deletePage"),h.onclick=u=>{u.stopPropagation(),p(),H(n)};const P=document.createElement("button");P.className="p-1 rounded hover:bg-gray-700",P.innerHTML='<i data-lucide="file-plus" class="w-4 h-4 text-gray-300"></i>',P.title=b("multiTool.actions.insertPdf"),P.onclick=u=>{u.stopPropagation(),p(),j(n)};const k=document.createElement("button");if(k.className="p-1 rounded hover:bg-gray-700",k.innerHTML='<i data-lucide="scissors" class="w-4 h-4 text-gray-300"></i>',k.title=b("multiTool.actions.toggleSplit"),k.onclick=u=>{u.stopPropagation(),p(),O(n),M()},s.append(m,f,d,P,k,h),o.append(a,r,i,c),v.has(n)){const u=document.createElement("div");u.className="split-marker absolute -right-3 top-0 bottom-0 w-6 flex items-center justify-center z-20 pointer-events-none",u.innerHTML='<div class="h-full w-0.5 border-l-2 border-dashed border-blue-400"></div>',o.appendChild(u)}return o}function ne(){const t=document.getElementById("pages-container");t&&(B&&B.destroy(),B=ie.create(t,{animation:150,forceFallback:!0,touchStartThreshold:3,fallbackTolerance:3,delay:200,delayOnTouchOnly:!0,scroll:document.getElementById("main-scroll-container"),scrollSensitivity:100,bubbleScroll:!1,onEnd:n=>{const e=n.oldIndex,o=n.newIndex;if(e!==o){const[a]=l.splice(e,1);l.splice(o,0,a),Ee()}}}))}function z(t){g.has(t)?g.delete(t):g.add(t);const n=document.getElementById("pages-container");if(!n)return;const e=n.children[t];if(!e)return;const o=e.querySelector('button[class*="absolute top-2 right-2"]');o&&(g.has(t)?(e.classList.add("border-indigo-500","ring-2","ring-indigo-500"),o.innerHTML='<i data-lucide="check-square" class="w-4 h-4 text-indigo-400"></i>'):(e.classList.remove("border-indigo-500","ring-2","ring-indigo-500"),o.innerHTML='<i data-lucide="square" class="w-4 h-4 text-gray-200"></i>'),L({icons:S}))}function fe(){g.clear(),l.forEach((t,n)=>g.add(n)),E()}function me(){g.clear(),E()}function x(t,n){p();const e=l[t];e.visualRotation=(e.visualRotation+n+360)%360,e.rotation=(e.rotation+n+360)%360;const o=document.getElementById("pages-container");if(!o)return;const a=o.children[t];if(!a)return;const r=a.querySelector("canvas"),i=a.querySelector(".bg-white");r&&i&&(r.style.transform=`rotate(${e.visualRotation}deg)`,r.style.transition="transform 0.2s ease")}function F(t){const n=l[t],e=n.canvas,o=document.createElement("canvas");o.width=e.width,o.height=e.height;const a=o.getContext("2d");a&&a.drawImage(e,0,0);const r={...n,id:N(),canvas:o},i=t+1;l.splice(i,0,r),E()}function H(t){l.splice(t,1),g.delete(t);const n=new Set;if(g.forEach(e=>{e>t?n.add(e-1):e<t&&n.add(e)}),g=n,l.length===0){C();return}E()}async function j(t){document.getElementById("insert-pdf-input")?.click(),window.__insertAfterIndex=t}async function pe(t){const n=t.target,e=n.files?.[0];if(!e)return;const o=window.__insertAfterIndex;if(o!==void 0){try{const a=await e.arrayBuffer(),r=await R.load(a,{ignoreEncryption:!0,throwOnInvalidObject:!1});T.push(r);const i=T.length-1,s=await r.save(),c=await K({data:new Uint8Array(s)}).promise,f=c.numPages,m=[];for(let d=0;d<f;d++)m.push({id:N(),pdfIndex:i,pageIndex:d,rotation:0,visualRotation:0,canvas:null,pdfDoc:r,originalPageIndex:d,fileName:e.name});l.splice(o+1,0,...m),E();for(let d=0;d<f;d++){const h=o+1+d,P=await se(c,d+1);if(l[h]){l[h].canvas=P;const u=document.getElementById("pages-container")?.querySelector(`div[data-page-index="${h}"]`);if(u){const D=u.querySelector(".bg-gray-700")||u.querySelector(".bg-white");if(D){D.innerHTML="",D.className="bg-white rounded mb-2 overflow-hidden w-full flex items-center justify-center relative h-36 sm:h-64";const A=P;A.className="max-w-full max-h-full object-contain",A.style.transform=`rotate(${l[h].visualRotation}deg)`,A.style.transition="transform 0.2s ease",D.appendChild(A)}}}}}catch(a){console.error("Failed to insert PDF:",a),w("Error","Failed to insert PDF. The file may be corrupted.","error")}n.value=""}}function O(t){v.has(t)?v.delete(t):v.add(t)}function M(){const t=document.getElementById("pages-container");t&&(t.querySelectorAll(".split-marker").forEach(n=>n.remove()),Array.from(t.children).forEach((n,e)=>{if(v.has(e)){const o=document.createElement("div");o.className="split-marker absolute -right-3 top-0 bottom-0 w-6 flex items-center justify-center z-20 pointer-events-none",o.innerHTML='<div class="h-full w-0.5 border-l-2 border-dashed border-blue-400"></div>',n.appendChild(o)}}))}function ye(){const t=document.createElement("canvas");t.width=595,t.height=842;const n=t.getContext("2d");n&&(n.fillStyle="white",n.fillRect(0,0,595,842));const e={id:N(),pdfIndex:-1,pageIndex:-1,rotation:0,visualRotation:0,canvas:t,pdfDoc:null,originalPageIndex:-1,fileName:""};l.push(e),E()}function Z(t){if(g.size===0){w("No Selection","Please select pages to rotate.","info");return}g.forEach(n=>{const e=l[n];if(e){e.visualRotation=(e.visualRotation+t+360)%360,e.rotation=(e.rotation+t+360)%360;const a=document.getElementById("pages-container")?.querySelector(`div[data-page-index="${n}"]`);if(a){const r=a.querySelector("canvas");r&&(r.style.transform=`rotate(${e.visualRotation}deg)`)}}})}function he(){if(g.size===0){w("No Selection","Please select pages to delete.","info");return}if(Array.from(g).sort((n,e)=>e-n).forEach(n=>l.splice(n,1)),g.clear(),l.length===0){C();return}E()}function be(){if(g.size===0){w("No Selection","Please select pages to duplicate.","info");return}Array.from(g).sort((n,e)=>e-n).forEach(n=>{F(n)}),g.clear(),E()}function ve(){if(g.size===0){w("No Selection","Please select pages to mark for splitting.","info");return}Array.from(g).forEach(n=>{v.has(n)||v.add(n)}),M(),g.clear(),E()}async function we(){if(l.length===0){w("No Pages","Please upload PDFs first.","info");return}if(v.size>0)await Pe();else{const t=Array.from({length:l.length},(n,e)=>e);await oe(t,"all-pages.pdf")}}async function Pe(){try{const t=new le,n=Array.from(v).sort((r,i)=>r-i),e=[];let o=[];for(let r=0;r<l.length;r++)o.push(r),v.has(r)&&(e.push(o),o=[]);o.length>0&&e.push(o);for(let r=0;r<e.length;r++){const i=e[r],s=await R.create();for(const f of i){const m=l[f];if(!m){console.warn(`Page data missing for index ${f}`);continue}if(m.pdfDoc&&m.originalPageIndex>=0){const[d]=await s.copyPages(m.pdfDoc,[m.originalPageIndex]),h=s.addPage(d);if(m.rotation!==0){const P=h.getRotation().angle;h.setRotation(Q(P+m.rotation))}}else s.addPage([595,842])}const c=await s.save();t.file(`document - ${r+1}.pdf`,c)}const a=await t.generateAsync({type:"blob"});X(a,"split-documents.zip"),w("Success",`Downloaded ${e.length} PDF files in a ZIP archive.`,"success")}catch(t){console.error("Failed to create split PDFs:",t),w("Error","Failed to create split PDFs.","error")}finally{Y()}}async function oe(t,n){try{const e=await R.create();for(const r of t){const i=l[r];if(!i){console.warn(`Page data missing for index ${r}`);continue}if(i.pdfDoc&&i.originalPageIndex>=0){const[s]=await e.copyPages(i.pdfDoc,[i.originalPageIndex]),c=e.addPage(s);if(i.rotation!==0){const f=c.getRotation().angle;c.setRotation(Q(f+i.rotation))}}else e.addPage([595,842])}const o=await e.save(),a=new Blob([new Uint8Array(o)],{type:"application/pdf"});X(a,n),w("Success","PDF downloaded successfully.","success")}catch(e){console.error("Failed to create PDF:",e),w("Error","Failed to create PDF.","error")}}function E(){const t=document.getElementById("pages-container");if(!t)return;const n=new Map;Array.from(t.children).forEach(e=>{const o=e;o.dataset.pageId&&n.set(o.dataset.pageId,o)}),l.forEach((e,o)=>{let a=n.get(e.id);if(a){n.delete(e.id),t.children[o]!==a&&(o<t.children.length?t.insertBefore(a,t.children[o]):t.appendChild(a)),a.dataset.pageIndex=o.toString();const r=a.querySelector(".text-xs.text-gray-400.text-center.mb-2");r&&(r.textContent=`Page ${o+1} `);const i=a.querySelector('button[class*="absolute top-2 right-2"]');i&&(g.has(o)?(a.classList.add("border-indigo-500","ring-2","ring-indigo-500"),i.innerHTML='<i data-lucide="check-square" class="w-4 h-4 text-indigo-400"></i>'):(a.classList.remove("border-indigo-500","ring-2","ring-indigo-500"),i.innerHTML='<i data-lucide="square" class="w-4 h-4 text-gray-200"></i>'),i.onclick=f=>{f.stopPropagation(),z(o)});const s=a.querySelector("canvas");s&&(s.style.transform=`rotate(${e.visualRotation}deg)`);const c=a.querySelector(".flex.items-center.gap-1.bg-gray-900\\/90");if(c){const f=c.querySelectorAll("button");f[0]&&(f[0].onclick=m=>{m.stopPropagation(),x(o,-90)}),f[1]&&(f[1].onclick=m=>{m.stopPropagation(),x(o,90)}),f[2]&&(f[2].onclick=m=>{m.stopPropagation(),p(),F(o)}),f[3]&&(f[3].onclick=m=>{m.stopPropagation(),p(),j(o)}),f[4]&&(f[4].onclick=m=>{m.stopPropagation(),p(),O(o),M()}),f[5]&&(f[5].onclick=m=>{m.stopPropagation(),p(),H(o)})}}else a=te(e.canvas,o),a.dataset.pageId=e.id,o<t.children.length?t.insertBefore(a,t.children[o]):t.appendChild(a)}),n.forEach(e=>e.remove()),ne(),M(),L({icons:S})}function Ee(){const t=document.getElementById("pages-container");if(!t)return;Array.from(t.children).forEach((e,o)=>{e.dataset.pageIndex=o.toString();const a=e.querySelector(".text-xs.text-gray-400.text-center.mb-2");a&&(a.textContent=`Page ${o+1} `);const r=e.querySelector('button[class*="absolute top-2 right-2"]');r&&(r.onclick=s=>{s.stopPropagation(),z(o)});const i=e.querySelector(".flex.items-center.gap-1.bg-gray-900\\/90");if(i){const s=i.querySelectorAll("button");s[0]&&(s[0].onclick=c=>{c.stopPropagation(),x(o,-90)}),s[1]&&(s[1].onclick=c=>{c.stopPropagation(),x(o,90)}),s[2]&&(s[2].onclick=c=>{c.stopPropagation(),p(),F(o)}),s[3]&&(s[3].onclick=c=>{c.stopPropagation(),p(),j(o)}),s[4]&&(s[4].onclick=c=>{c.stopPropagation(),p(),O(o),M()}),s[5]&&(s[5].onclick=c=>{c.stopPropagation(),p(),H(o)})}})}
