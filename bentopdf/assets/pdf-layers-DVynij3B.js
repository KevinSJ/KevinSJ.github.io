import{c as H,i as X}from"./style-D1FQfXNQ.js";import"./version-Dw8ZKLCV.js";import"./simple-mode-footer-D78rH_WB.js";import{m as z,n as G,a as m,b as I,h as w,f as F,r as q,c as U,d as W}from"./main-Da82M_MD.js";import"./mobileMenu-BoMunYmR.js";const M=new z(G("pymupdf"));let c=null,p=null;const u=new Map;let g=0;document.addEventListener("DOMContentLoaded",()=>{const L=document.getElementById("file-input"),i=document.getElementById("drop-zone"),h=document.getElementById("process-btn"),v=document.getElementById("process-btn-container"),x=document.getElementById("file-display-area"),b=document.getElementById("layers-container"),y=document.getElementById("layers-list"),D=document.getElementById("back-to-tools");D&&D.addEventListener("click",()=>{window.location.href="/"});const O=async()=>{if(!(!x||!v||!h))if(c){x.innerHTML="";const t=document.createElement("div");t.className="flex items-center justify-between bg-gray-700 p-3 rounded-lg text-sm";const n=document.createElement("div");n.className="flex flex-col overflow-hidden";const e=document.createElement("div");e.className="truncate font-medium text-gray-200 text-sm mb-1",e.textContent=c.name;const r=document.createElement("div");r.className="text-xs text-gray-400",r.textContent=`${F(c.size)} â€¢ Loading pages...`,n.append(e,r);const a=document.createElement("button");a.className="ml-4 text-red-400 hover:text-red-300 flex-shrink-0",a.innerHTML='<i data-lucide="trash-2" class="w-4 h-4"></i>',a.onclick=()=>{$()},t.append(n,a),x.appendChild(t);try{const d=await q(c),o=await U({data:d}).promise;r.textContent=`${F(c.size)} â€¢ ${o.numPages} pages`}catch(d){console.error("Error loading PDF:",d),r.textContent=`${F(c.size)} â€¢ Could not load page count`}H({icons:X}),v.classList.remove("hidden"),h.disabled=!1}else x.innerHTML="",v.classList.add("hidden"),h.disabled=!0},$=()=>{c=null,p=null,u.clear(),g=0,i&&(i.style.display="flex"),b&&b.classList.add("hidden"),O()},N=(t,n,e="")=>new Promise(r=>{const a=document.getElementById("input-modal"),d=document.getElementById("input-title"),o=document.getElementById("input-message"),s=document.getElementById("input-value"),l=document.getElementById("input-confirm"),f=document.getElementById("input-cancel");if(!a||!d||!o||!s||!l||!f){console.error("Input modal elements not found"),r(null);return}d.textContent=t,o.textContent=n,s.value=e;const E=()=>{a.classList.add("hidden"),l.onclick=null,f.onclick=null,s.onkeydown=null},P=()=>{const B=s.value.trim();E(),r(B)},A=()=>{E(),r(null)};l.onclick=P,f.onclick=A,s.onkeydown=B=>{B.key==="Enter"&&P(),B.key==="Escape"&&A()},a.classList.remove("hidden"),s.focus()}),k=()=>{if(!y)return;const t=Array.from(u.values());if(t.length===0){y.innerHTML=`
                <div class="layers-empty">
                    <p>This PDF has no layers (OCG).</p>
                    <p>Add a new layer to get started!</p>
                </div>
            `;return}const n=t.sort((e,r)=>e.displayOrder-r.displayOrder);y.innerHTML=n.map(e=>`
            <div class="layer-item" data-number="${e.number}" style="padding-left: ${e.depth*24+8}px;">
                <label class="layer-toggle">
                    <input type="checkbox" ${e.on?"checked":""} ${e.locked?"disabled":""} data-xref="${e.xref}" />
                    <span class="layer-name">${e.depth>0?"â”” ":""}${e.text||`Layer ${e.number}`}</span>
                    ${e.locked?'<span class="layer-locked">ðŸ”’</span>':""}
                </label>
                <div class="layer-actions">
                    ${e.locked?"":`<button class="layer-add-child" data-xref="${e.xref}" title="Add child layer">+</button>`}
                    ${e.locked?"":`<button class="layer-delete" data-xref="${e.xref}" title="Delete layer">âœ•</button>`}
                </div>
            </div>
        `).join(""),y.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",r=>{const a=r.target,d=parseInt(a.dataset.xref||"0"),o=a.checked;try{p.setLayerVisibility(d,o);const s=Array.from(u.values()).find(l=>l.xref===d);s&&(s.on=o)}catch(s){console.error("Failed to set layer visibility:",s),a.checked=!o,m("Error","Failed to toggle layer visibility")}})}),y.querySelectorAll(".layer-delete").forEach(e=>{e.addEventListener("click",r=>{const a=r.target,d=parseInt(a.dataset.xref||"0"),o=Array.from(u.values()).find(s=>s.xref===d);if(!o){m("Error","Layer not found");return}try{p.deleteOCG(o.number),u.delete(o.number),k()}catch(s){console.error("Failed to delete layer:",s),m("Error","Failed to delete layer")}})}),y.querySelectorAll(".layer-add-child").forEach(e=>{e.addEventListener("click",async r=>{const a=r.target,d=parseInt(a.dataset.xref||"0"),o=Array.from(u.values()).find(l=>l.xref===d),s=await N("Add Child Layer",`Enter name for child layer under "${o?.text||"Layer"}":`);if(!(!s||!s.trim()))try{const l=p.addOCGWithParent(s.trim(),d),f=o?.displayOrder||0;u.forEach(E=>{E.displayOrder>f&&(E.displayOrder+=1)}),u.set(l,{number:l,xref:l,text:s.trim(),on:!0,locked:!1,depth:(o?.depth||0)+1,parentXref:d,displayOrder:f+1}),k()}catch(l){console.error("Failed to add child layer:",l),m("Error","Failed to add child layer")}})})},S=async()=>{if(!c){m("No File","Please select a PDF file.");return}try{I("Loading engine..."),await M.load(),I(`Loading layers from ${c.name}...`),p=await M.open(c),I("Reading layer configuration...");const t=p.getLayerConfig();u.clear(),g=0,t.forEach(n=>{u.set(n.number,{number:n.number,xref:n.xref??n.number,text:n.text,on:n.on,locked:n.locked,depth:n.depth??0,parentXref:n.parentXref??0,displayOrder:n.displayOrder??g++}),(n.displayOrder??-1)>=g&&(g=n.displayOrder+1)}),w(),i&&(i.style.display="none"),v&&v.classList.add("hidden"),b&&b.classList.remove("hidden"),k(),T()}catch(t){w(),m("Error",t.message||"Failed to load PDF layers"),console.error("Layers error:",t)}},T=()=>{const t=document.getElementById("add-layer-btn"),n=document.getElementById("new-layer-name"),e=document.getElementById("save-layers-btn");t&&n&&(t.onclick=()=>{const r=n.value.trim();if(!r){m("Invalid Name","Please enter a layer name");return}try{const a=p.addOCG(r);n.value="";const d=g++;u.set(a,{number:a,xref:a,text:r,on:!0,locked:!1,depth:0,parentXref:0,displayOrder:d}),k()}catch(a){m("Error","Failed to add layer: "+a.message)}}),e&&(e.onclick=()=>{try{I("Saving PDF with layer changes...");const r=p.save(),a=new Blob([new Uint8Array(r)],{type:"application/pdf"}),d=c.name.replace(/\.pdf$/i,"")+"_layers.pdf";W(a,d),w(),$(),m("Success","PDF with layer changes saved!","success")}catch(r){w(),m("Error","Failed to save PDF: "+r.message)}})},C=t=>{if(t&&t.length>0){const n=t[0];n.type==="application/pdf"||n.name.toLowerCase().endsWith(".pdf")?(c=n,O()):m("Invalid File","Please select a PDF file.")}};L&&i&&(L.addEventListener("change",t=>{C(t.target.files)}),i.addEventListener("dragover",t=>{t.preventDefault(),i.classList.add("bg-gray-700")}),i.addEventListener("dragleave",t=>{t.preventDefault(),i.classList.remove("bg-gray-700")}),i.addEventListener("drop",t=>{t.preventDefault(),i.classList.remove("bg-gray-700"),C(t.dataTransfer?.files??null)}),L.addEventListener("click",()=>{L.value=""})),h&&h.addEventListener("click",S)});
