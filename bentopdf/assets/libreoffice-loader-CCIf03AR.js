var y="/wasm/";function m(t=y){let e=t.endsWith("/")?t:`${t}/`;return{sofficeJs:`${e}soffice.js`,sofficeWasm:`${e}soffice.wasm`,sofficeData:`${e}soffice.data`,sofficeWorkerJs:`${e}soffice.worker.js`}}var I=(t=>(t.UNKNOWN="UNKNOWN",t.INVALID_INPUT="INVALID_INPUT",t.UNSUPPORTED_FORMAT="UNSUPPORTED_FORMAT",t.CORRUPTED_DOCUMENT="CORRUPTED_DOCUMENT",t.PASSWORD_REQUIRED="PASSWORD_REQUIRED",t.WASM_NOT_INITIALIZED="WASM_NOT_INITIALIZED",t.CONVERSION_FAILED="CONVERSION_FAILED",t.LOAD_FAILED="LOAD_FAILED",t))(I||{}),o=class extends Error{code;details;constructor(t,e,i){super(e),this.name="ConversionError",this.code=t,this.details=i}},u={pdf:"writer_pdf_Export",docx:"MS Word 2007 XML",doc:"MS Word 97",odt:"writer8",rtf:"Rich Text Format",txt:"Text",html:"HTML (StarWriter)",xlsx:"Calc MS Excel 2007 XML",xls:"MS Excel 97",ods:"calc8",csv:"Text - txt - csv (StarCalc)",pptx:"Impress MS PowerPoint 2007 XML",ppt:"MS PowerPoint 97",odp:"impress8",png:"writer_png_Export",jpg:"writer_jpg_Export",svg:"writer_svg_Export"},v={pdf:"application/pdf",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",doc:"application/msword",odt:"application/vnd.oasis.opendocument.text",rtf:"application/rtf",txt:"text/plain",html:"text/html",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xls:"application/vnd.ms-excel",ods:"application/vnd.oasis.opendocument.spreadsheet",csv:"text/csv",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",ppt:"application/vnd.ms-powerpoint",odp:"application/vnd.oasis.opendocument.presentation",png:"image/png",jpg:"image/jpeg",svg:"image/svg+xml"};new TextEncoder;new TextDecoder;var _=class{worker=null;initialized=!1;initializing=!1;messageId=0;pendingRequests=new Map;options;constructor(t={}){let e=m();this.options={verbose:!1,browserWorkerJs:"/dist/browser.worker.global.js",...e,...t}}async initialize(){if(!this.initialized){if(this.initializing){for(;this.initializing;)await new Promise(t=>setTimeout(t,100));return}this.initializing=!0,this.emitProgress("loading",0,"Starting worker...");try{this.worker=new Worker(this.options.browserWorkerJs),this.worker.onmessage=t=>this.handleWorkerMessage(t),this.worker.onerror=t=>{console.error("[WorkerConverter] Worker error:",t),this.options.onError?.(new o("WASM_NOT_INITIALIZED",t.message))},await new Promise((t,e)=>{let i=setTimeout(()=>e(new Error("Worker load timeout")),1e4),r=s=>{s.data.type==="loaded"&&(clearTimeout(i),this.worker?.removeEventListener("message",r),t())};this.worker.addEventListener("message",r)}),await this.sendMessage("init",{sofficeJs:this.options.sofficeJs,sofficeWasm:this.options.sofficeWasm,sofficeData:this.options.sofficeData,sofficeWorkerJs:this.options.sofficeWorkerJs,enableProgressTracking:this.options.enableProgressTracking,verbose:this.options.verbose}),this.initialized=!0,this.emitProgress("complete",100,"Ready"),this.options.onReady?.()}catch(t){let e=t instanceof o?t:new o("WASM_NOT_INITIALIZED",String(t));throw this.options.onError?.(e),e}finally{this.initializing=!1}}}handleWorkerMessage(t){let e=t.data;if(e.type==="progress"){let r=e.progress;r&&this.emitProgress("converting",r.percent,r.message);return}let i=this.pendingRequests.get(e.id);i&&(this.pendingRequests.delete(e.id),e.type==="error"?i.reject(new o("CONVERSION_FAILED",e.error??"Unknown error")):e.type==="result"?i.resolve(e.data):e.type==="ready"?i.resolve(void 0):e.type==="pageCount"?i.resolve(e.pageCount):e.type==="previews"?i.resolve(e.previews):e.type==="singlePagePreview"||e.type==="fullQualityPagePreview"?i.resolve(e.preview):e.type==="documentInfo"?i.resolve(e.documentInfo):e.type==="lokInfo"?i.resolve(e.lokInfo):e.type==="editResult"?i.resolve(e.editResult):e.type==="pageRectangles"?i.resolve(e.pageRectangles):e.type==="testLokOperations"?i.resolve(e.testLokOperationsResult):e.type==="editorSession"?i.resolve(e.editorSession):e.type==="editorOperationResult"?i.resolve(e.editorOperationResult):e.type==="documentClosed"&&i.resolve(e.data))}sendMessage(t,e={}){return new Promise((i,r)=>{if(!this.worker){r(new Error("Worker not initialized"));return}let s=++this.messageId;if(this.pendingRequests.set(s,{resolve:i,reject:r}),e.inputData instanceof Uint8Array){let n=new Uint8Array(e.inputData.length);n.set(e.inputData);let a={type:t,id:s,...e,inputData:n};this.worker.postMessage(a,[n.buffer])}else{let n={type:t,id:s,...e};this.worker.postMessage(n)}})}async convert(t,e,i="document"){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let r=Date.now(),s=t instanceof Uint8Array?t:new Uint8Array(t);if(s.length===0)throw new o("INVALID_INPUT","Empty document");let n=this.getExt(i)||e.inputFormat||"docx",a=e.outputFormat;if(!u[a])throw new o("UNSUPPORTED_FORMAT",`Unsupported: ${a}`);let c="";if(a==="pdf"&&e.pdf){let l=[];if(e.pdf.pdfaLevel){let w={"PDF/A-1b":1,"PDF/A-2b":2,"PDF/A-3b":3};l.push(`SelectPdfVersion=${w[e.pdf.pdfaLevel]||0}`)}e.pdf.quality!==void 0&&l.push(`Quality=${e.pdf.quality}`),c=l.join(",")}let d=await this.sendMessage("convert",{inputData:s,inputExt:n,outputFormat:a,filterOptions:c,password:e.password}),h=i.includes(".")?i.substring(0,i.lastIndexOf(".")):i,f=d.length>=2&&d[0]===80&&d[1]===75,g=["png","jpg","jpeg","svg"].includes(a.toLowerCase());return f&&g?{data:d,mimeType:"application/zip",filename:`${h}_pages.zip`,duration:Date.now()-r}:{data:d,mimeType:v[a],filename:`${h}.${a}`,duration:Date.now()-r}}async convertFile(t,e){let i=await t.arrayBuffer();return this.convert(new Uint8Array(i),e,t.name)}async convertFromUrl(t,e){let i=await fetch(t);if(!i.ok)throw new Error(`Fetch failed: ${i.statusText}`);let r=await i.arrayBuffer(),s=t.split("/").pop()||"document";return this.convert(new Uint8Array(r),e,s)}download(t,e){let i=new Uint8Array(t.data).buffer,r=new Blob([i],{type:t.mimeType}),s=URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=e||t.filename,n.click(),setTimeout(()=>URL.revokeObjectURL(s),1e3)}createBlobUrl(t){let e=new Uint8Array(t.data).buffer,i=new Blob([e],{type:t.mimeType});return URL.createObjectURL(i)}preview(t){return window.open(this.createBlobUrl(t),"_blank")}async getPageCount(t,e){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let i=t instanceof Uint8Array?t:new Uint8Array(t),r=e.inputFormat||"docx";return await this.sendMessage("getPageCount",{inputData:i,inputExt:r})}async renderPreviews(t,e,i=256){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let r=t instanceof Uint8Array?t:new Uint8Array(t),s=e.inputFormat||"docx";return await this.sendMessage("renderPreviews",{inputData:r,inputExt:s,maxWidth:i})}async renderSinglePage(t,e,i,r=256){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let s=t instanceof Uint8Array?t:new Uint8Array(t),n=e.inputFormat||"docx";return await this.sendMessage("renderSinglePage",{inputData:s,inputExt:n,pageIndex:i,maxWidth:r})}async renderPageViaConvert(t,e,i,r=256){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let s=t instanceof Uint8Array?t:new Uint8Array(t),n=e.inputFormat||"pdf";return await this.sendMessage("renderPageViaConvert",{inputData:s,inputExt:n,pageIndex:i,maxWidth:r})}async getDocumentInfo(t,e){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let i=t instanceof Uint8Array?t:new Uint8Array(t),r=e.inputFormat||"docx";return await this.sendMessage("getDocumentInfo",{inputData:i,inputExt:r})}async getLokInfo(t,e){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let i=t instanceof Uint8Array?t:new Uint8Array(t),r=e.inputFormat||"docx";return await this.sendMessage("getLokInfo",{inputData:i,inputExt:r})}async renderPageRectangles(t,e,i=256){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let r=t instanceof Uint8Array?t:new Uint8Array(t),s=e.inputFormat||"docx";return await this.sendMessage("renderPageRectangles",{inputData:r,inputExt:s,maxWidth:i})}async editText(t,e,i){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let r=t instanceof Uint8Array?t:new Uint8Array(t),s=e.inputFormat||"docx";return await this.sendMessage("editText",{inputData:r,inputExt:s,findText:i.findText,replaceText:i.replaceText,insertText:i.insertText})}async testLokOperations(t,e){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let i=t instanceof Uint8Array?t:new Uint8Array(t),r=e.inputFormat||"docx";return await this.sendMessage("testLokOperations",{inputData:i,inputExt:r})}async openDocument(t,e){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let i=t instanceof Uint8Array?t:new Uint8Array(t),r=e.inputFormat||"docx",s=await this.sendMessage("openDocument",{inputData:i,inputExt:r});return new O(this,s.sessionId,s.documentType,s.pageCount)}async _sendEditorOperation(t,e,i=[]){return await this.sendMessage("editorOperation",{sessionId:t,editorMethod:e,editorArgs:i})}async _closeDocument(t){return await this.sendMessage("closeDocument",{sessionId:t})}async renderPage(t,e,i,r,s){return this.renderSinglePage(t,e,i,r)}async renderPagePreviews(t,e,i){let r=i?.width??256;return this.renderPreviews(t,e,r)}async renderPageFullQuality(t,e,i,r){if(!this.initialized||!this.worker)throw new o("WASM_NOT_INITIALIZED","Not initialized");let s=t instanceof Uint8Array?t:new Uint8Array(t),n=e.inputFormat||"docx";return await this.sendMessage("renderPageFullQuality",{inputData:s,inputExt:n,pageIndex:i,dpi:r?.dpi??150,maxDimension:r?.maxDimension,editMode:r?.editMode??!1})}async editorOperation(t,e,i){return await this._sendEditorOperation(t,e,i??[])}async closeDocument(t){return this._closeDocument(t)}async destroy(){if(this.worker){try{await this.sendMessage("destroy")}catch{}this.worker.terminate(),this.worker=null}this.initialized=!1,this.pendingRequests.clear()}isReady(){return this.initialized&&this.worker!==null}static getSupportedOutputFormats(){return Object.keys(u)}getExt(t){let e=t.split(".");return e.length>1&&e.pop()?.toLowerCase()||null}emitProgress(t,e,i){this.options.onProgress?.({phase:t,percent:e,message:i})}},O=class{converter;_sessionId;_documentType;_pageCount;_closed=!1;constructor(t,e,i,r){this.converter=t,this._sessionId=e,this._documentType=i,this._pageCount=r}get sessionId(){return this._sessionId}get documentType(){return this._documentType}get pageCount(){return this._pageCount}get isOpen(){return!this._closed}async getStructure(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getStructure")}async undo(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"undo")}async redo(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"redo")}async find(t,e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"find",[t,e])}async findAndReplaceAll(t,e,i){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"findAndReplaceAll",[t,e,i])}async getSelection(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getSelection")}async clearSelection(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"clearSelection")}async getStateChanges(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getStateChanges")}async flushAndPollState(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"flushAndPollState")}async getFormat(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getFormat")}async getSelectionFormat(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getSelectionFormat")}async getParagraph(t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getParagraph",[t])}async getParagraphs(t,e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getParagraphs",[t,e])}async insertParagraph(t,e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"insertParagraph",[t,e])}async replaceParagraph(t,e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"replaceParagraph",[t,e])}async deleteParagraph(t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"deleteParagraph",[t])}async formatText(t,e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"formatText",[t,e])}async replaceText(t,e,i){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"replaceText",[t,e,i])}async close(){return this.assertOpen(),this._closed=!0,this.converter._closeDocument(this._sessionId)}assertOpen(){if(this._closed)throw new Error("Document session is closed")}};const E="/bentopdf/libreoffice-wasm/";let p=null;class A{converter=null;initialized=!1;initializing=!1;basePath;constructor(e){this.basePath=e||E}async initialize(e){if(this.initialized)return;if(this.initializing){for(;this.initializing;)await new Promise(r=>setTimeout(r,100));return}this.initializing=!0;let i=e;try{i?.({phase:"loading",percent:0,message:"Loading conversion engine..."}),this.converter=new _({sofficeJs:`${this.basePath}soffice.js`,sofficeWasm:`${this.basePath}soffice.wasm.gz`,sofficeData:`${this.basePath}soffice.data.gz`,sofficeWorkerJs:`${this.basePath}soffice.worker.js`,browserWorkerJs:`${this.basePath}browser.worker.global.js`,verbose:!1,onProgress:r=>{if(i&&!this.initialized){const s=`Loading conversion engine (${Math.round(r.percent)}%)...`;i({phase:r.phase,percent:r.percent,message:s})}},onReady:()=>{console.log("[LibreOffice] Ready!")},onError:r=>{console.error("[LibreOffice] Error:",r)}}),await this.converter.initialize(),this.initialized=!0,i?.({phase:"ready",percent:100,message:"Conversion engine ready!"}),i=void 0}finally{this.initializing=!1}}isReady(){return this.initialized&&this.converter!==null}async convertToPdf(e){if(!this.converter)throw new Error("Converter not initialized");console.log(`[LibreOffice] Converting ${e.name} to PDF...`),console.log(`[LibreOffice] File type: ${e.type}, Size: ${e.size} bytes`);try{console.log("[LibreOffice] Reading file as ArrayBuffer...");const i=await e.arrayBuffer(),r=new Uint8Array(i);console.log(`[LibreOffice] File loaded, ${r.length} bytes`),console.log("[LibreOffice] Calling converter.convert() with buffer...");const s=Date.now(),n=e.name.split(".").pop()?.toLowerCase()||"";console.log(`[LibreOffice] Detected format from extension: ${n}`);const a=await this.converter.convert(r,{outputFormat:"pdf",inputFormat:n},e.name),c=Date.now()-s;console.log(`[LibreOffice] Conversion complete! Duration: ${c}ms, Size: ${a.data.length} bytes`);const d=new Uint8Array(a.data);return new Blob([d],{type:a.mimeType})}catch(i){throw console.error(`[LibreOffice] Conversion FAILED for ${e.name}:`,i),console.error("[LibreOffice] Error details:",{message:i instanceof Error?i.message:String(i),stack:i instanceof Error?i.stack:void 0}),i}}async wordToPdf(e){return this.convertToPdf(e)}async pptToPdf(e){return this.convertToPdf(e)}async excelToPdf(e){return this.convertToPdf(e)}async destroy(){this.converter&&await this.converter.destroy(),this.converter=null,this.initialized=!1}}function T(t){return p||(p=new A(t)),p}export{T as g};
