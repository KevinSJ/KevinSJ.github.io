import{c as ye,i as he}from"./style-CNx3HTbi.js";import"./version-D4ympJL5.js";import"./full-width-DliZ98Ur.js";import"./simple-mode-footer-ODFatrFN.js";import{G as lt,N as ot,P as at,e as st,O as it,d as Ie,x as B,f as rt,k as ct,Q as dt,R as se,t as ut}from"./main-Dqs2Ohqn.js";import{i as mt}from"./shortcuts-init-C3Q6CKFj.js";import"./mobileMenu-BoMunYmR.js";const pt={red:"bg-red-100 border-red-300",blue:"bg-blue-100 border-blue-300",green:"bg-green-100 border-green-300",yellow:"bg-yellow-100 border-yellow-300",purple:"bg-purple-100 border-purple-300"},gt={red:"text-red-600",blue:"text-blue-600",green:"text-green-600",yellow:"text-yellow-600",purple:"text-purple-600"},ft={red:"#dc2626",blue:"#2563eb",green:"#16a34a",yellow:"#ca8a04",purple:"#9333ea"},Ce={red:[1,0,0],blue:[0,0,1],green:[0,1,0],yellow:[1,1,0],purple:[.5,0,.5]};lt.workerSrc=new URL("/bentopdf/assets/pdf.worker.min-LyOxJPrg.mjs",import.meta.url).toString();const O=document.getElementById("modal-container");let pe=!1,ge=null,z=null,ce=null,Xe=null,H=1;const fe=document.getElementById("file-input"),ke=document.getElementById("csv-input"),Ee=document.getElementById("json-input"),yt=document.getElementById("auto-extract-checkbox"),Ye=document.getElementById("app"),Fe=document.getElementById("uploader"),Pe=document.getElementById("loader-modal"),ie=document.getElementById("file-display-area"),Ne=document.getElementById("back-to-tools"),De=document.getElementById("back-btn"),Z=document.getElementById("pdf-canvas"),y=Z?.getContext("2d")??null,ht=document.getElementById("page-indicator"),vt=document.getElementById("prev-page"),bt=document.getElementById("next-page"),U=document.getElementById("goto-page"),je=document.getElementById("goto-btn"),xt=document.getElementById("zoom-in-btn"),kt=document.getElementById("zoom-out-btn"),Et=document.getElementById("zoom-fit-btn"),$e=document.getElementById("zoom-indicator"),Ae=document.getElementById("add-top-level-btn"),de=document.getElementById("bookmark-title"),re=document.getElementById("bookmark-tree-list"),ze=document.getElementById("no-bookmarks"),wt=document.getElementById("download-btn"),we=document.getElementById("undo-btn"),Le=document.getElementById("redo-btn"),Lt=document.getElementById("reset-btn"),It=document.getElementById("delete-all-btn"),Bt=document.getElementById("search-bookmarks"),St=document.getElementById("import-dropdown-btn"),Ct=document.getElementById("export-dropdown-btn"),ne=document.getElementById("import-dropdown"),le=document.getElementById("export-dropdown"),Pt=document.getElementById("import-csv-btn"),Nt=document.getElementById("export-csv-btn"),Dt=document.getElementById("import-json-btn"),$t=document.getElementById("export-json-btn"),ue=document.getElementById("csv-import-hidden"),me=document.getElementById("json-import-hidden"),zt=document.getElementById("extract-existing-btn"),Me=document.getElementById("current-page-display"),Te=document.getElementById("filename-display"),Mt=document.getElementById("batch-mode-checkbox"),Be=document.getElementById("batch-operations"),Oe=document.getElementById("selected-count"),Tt=document.getElementById("batch-color-select"),Ot=document.getElementById("batch-style-select"),qt=document.getElementById("batch-delete-btn"),Xt=document.getElementById("select-all-btn"),Yt=document.getElementById("deselect-all-btn"),Ft=document.getElementById("expand-all-btn"),jt=document.getElementById("collapse-all-btn"),F=document.getElementById("show-viewer-btn"),J=document.getElementById("show-bookmarks-btn"),ve=document.getElementById("viewer-section"),be=document.getElementById("bookmarks-section");function qe(e,l=[],t={}){return new Promise(n=>{const a=document.createElement("div");a.className="modal-overlay",a.id="active-modal-overlay";const o=document.createElement("div");o.className="modal-content",o.id="active-modal";const f=l.map(s=>{if(s.type==="text")return`
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
      <input type="text" id="modal-${s.name}" value="${et(String(t[s.name]||""))}"
class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900"
placeholder="${s.placeholder||""}" />
  </div>
    `;if(s.type==="select")return`
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
      <select id="modal-${s.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900">
        ${s.options.map(i=>`
                                        <option value="${i.value}" ${t[s.name]===i.value?"selected":""}>
                                            ${i.label}
                                        </option>
                                    `).join("")}
</select>
                                ${s.name==="color"?'<input type="color" id="modal-color-picker" class="hidden w-full h-10 mt-2 rounded cursor-pointer border border-gray-300" value="#000000" />':""}
</div>
  `;if(s.type==="destination"){const i=t.destX!==null&&t.destX!==void 0;return`
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
      <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-1 text-xs">
            <input type="checkbox" id="modal-use-destination" class="w-4 h-4" ${i?"checked":""}>
              <span class="text-gray-700">Set custom destination</span>
                </label>
                </div>
                <div id="destination-controls" class="${i?"":"hidden"} space-y-2">
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                    <label class="text-xs text-gray-600">Page</label>
                      <input type="number" id="modal-dest-page" min="1" max="${s.maxPages||1}" value="${t.destPage||s.page||1}"
class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-gray-900" step="1" />
  </div>
  <div>
  <label class="text-xs text-gray-600">Zoom(%)</label>
    <select id="modal-dest-zoom" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-gray-900">
      <option value="">Inherit</option>
        <option value="0">Fit Page</option>
          <option value="50">50%</option>
            <option value="75">75%</option>
              <option value="100">100%</option>
                <option value="125">125%</option>
                  <option value="150">150%</option>
                    <option value="200">200%</option>
                      </select>
                      </div>
                      </div>
                      <div class="grid grid-cols-2 gap-2">
                        <div>
                        <label class="text-xs text-gray-600">X Position</label>
                          <input type="number" id="modal-dest-x" value="0" step="10"
class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-gray-900" />
  </div>
  <div>
  <label class="text-xs text-gray-600">Y Position</label>
    <input type="number" id="modal-dest-y" value="0" step="10"
class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-gray-900" />
  </div>
  </div>
  <button id="modal-pick-destination" class="w-full px-3 py-2 btn-gradient text-white rounded text-xs !flex items-center justify-center gap-1">
    <i data-lucide="crosshair" class="w-3 h-3"></i> Click on PDF to Pick Location
      </button>
      <p class="text-xs text-gray-500 italic">Click the button above, then click on the PDF where you want the bookmark to jump to</p>
        </div>
        </div>
        </div>
          `}else if(s.type==="preview")return`
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
            <div id="modal-preview" class="style-preview bg-gray-50">
              <span id="preview-text" style="font-size: 16px;">Preview Text</span>
                </div>
                </div>
                  `;return""}).join("");o.innerHTML=`
                <div class="p-6">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">${e}</h3>
                    <div class="mb-6">
                      ${f}
</div>
  <div class="flex gap-2 justify-end">
    <button id="modal-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</button>
      <button id="modal-confirm" class="px-4 py-2 rounded btn-gradient text-white">Confirm</button>
        </div>
        </div>
          `,a.appendChild(o),O?.appendChild(a);function d(){const s=o.querySelector("#preview-text");if(s){const i=o.querySelector("#modal-title"),r=o.querySelector("#modal-color"),b=o.querySelector("#modal-style"),S=o.querySelector("#modal-color-picker"),$=i?i.value:"Preview Text",W=r?r.value:"",Y=b?b.value:"";s.textContent=$||"Preview Text",W==="custom"&&S?s.style.color=S.value:s.style.color=ft[W]||"#000",s.style.fontWeight=Y==="bold"||Y==="bold-italic"?"bold":"normal",s.style.fontStyle=Y==="italic"||Y==="bold-italic"?"italic":"normal"}}const c=o.querySelector("#modal-title"),m=o.querySelector("#modal-color"),I=o.querySelector("#modal-style");c&&c.addEventListener("input",d),m&&m.addEventListener("change",s=>{const i=s.target,r=o.querySelector("#modal-color-picker");i.value==="custom"&&r?(r.classList.remove("hidden"),setTimeout(()=>r.click(),100)):r&&r.classList.add("hidden"),d()});const p=o.querySelector("#modal-color-picker");p&&p.addEventListener("input",d),I&&I.addEventListener("change",d);const w=o.querySelector("#modal-use-destination"),L=o.querySelector("#destination-controls"),u=o.querySelector("#modal-pick-destination");if(w&&L&&(w.addEventListener("change",s=>{const i=s.target;L.classList.toggle("hidden",!i.checked)}),t.destX!==null&&t.destX!==void 0)){const s=o.querySelector("#modal-dest-page"),i=o.querySelector("#modal-dest-x"),r=o.querySelector("#modal-dest-y"),b=o.querySelector("#modal-dest-zoom");s&&t.destPage!==void 0&&(s.value=String(t.destPage)),i&&t.destX!==null&&(i.value=String(Math.round(t.destX))),r&&t.destY!==null&&(r.value=String(Math.round(t.destY))),b&&t.zoom!==null&&(b.value=t.zoom||"")}u&&u.addEventListener("click",()=>{ce=a,a.style.display="none",At((s,i,r)=>{const b=o.querySelector("#modal-dest-page"),S=o.querySelector("#modal-dest-x"),$=o.querySelector("#modal-dest-y");b&&(b.value=String(s)),S&&(S.value=String(Math.round(i))),$&&($.value=String(Math.round(r))),a.style.display="",setTimeout(()=>{h()},100)})});const v=o.querySelector("#modal-dest-page");v&&(v.addEventListener("input",s=>{const i=s.target,r=parseInt(i.value),b=parseInt(i.max)||1;isNaN(r)||r<1?i.value="1":r>b?i.value=String(b):i.value=String(Math.floor(r)),h()}),v.addEventListener("blur",s=>{const i=s.target,r=parseInt(i.value),b=parseInt(i.max)||1;isNaN(r)||r<1?i.value="1":r>b?i.value=String(b):i.value=String(Math.floor(r)),h()}));function h(){if(!k)return;const s=o.querySelector("#modal-dest-page"),i=o.querySelector("#modal-dest-x"),r=o.querySelector("#modal-dest-y"),b=o.querySelector("#modal-dest-zoom"),S=s?parseInt(s.value):P,$=i?parseFloat(i.value):null,W=r?parseFloat(r.value):null,Y=b?b.value:null;S>=1&&S<=k.numPages&&Ze(S,$,W,Y)}const T=o.querySelector("#modal-dest-x"),X=o.querySelector("#modal-dest-y"),R=o.querySelector("#modal-dest-zoom");T&&T.addEventListener("input",h),X&&X.addEventListener("input",h),R&&R.addEventListener("change",h),d(),o.querySelector("#modal-cancel")?.addEventListener("click",()=>{V(),O?.removeChild(a),n(null)}),o.querySelector("#modal-confirm")?.addEventListener("click",()=>{const s={};l.forEach(S=>{if(S.type!=="preview"&&S.type!=="destination"){const $=o.querySelector(`#modal-${S.name}`);$&&(s[S.name]=$.value)}});const i=o.querySelector("#modal-color"),r=o.querySelector("#modal-color-picker");i&&i.value==="custom"&&r&&(s.color=r.value);const b=o.querySelector("#modal-use-destination");if(b&&b.checked){const S=o.querySelector("#modal-dest-page"),$=o.querySelector("#modal-dest-x"),W=o.querySelector("#modal-dest-y"),Y=o.querySelector("#modal-dest-zoom");s.destPage=S?parseInt(S.value):null,s.destX=$?parseFloat($.value):null,s.destY=W?parseFloat(W.value):null,s.zoom=Y&&Y.value?Y.value:null}else s.destPage=null,s.destX=null,s.destY=null,s.zoom=null;V(),O?.removeChild(a),n(s)}),a.addEventListener("click",s=>{s.target===a&&(V(),O?.removeChild(a),n(null))}),setTimeout(()=>{const s=o.querySelector("input, select");s&&s.focus()},0),ye({icons:he})})}function At(e){pe=!0,ge=e;const l=document.getElementById("pdf-canvas-wrapper"),t=document.getElementById("picking-mode-banner");l?.classList.add("picking-mode"),t?.classList.remove("hidden"),window.innerWidth<1024&&document.getElementById("show-viewer-btn")?.click(),ye({icons:he})}function V(){pe=!1,ge=null;const e=document.getElementById("pdf-canvas-wrapper"),l=document.getElementById("picking-mode-banner");e?.classList.remove("picking-mode"),l?.classList.add("hidden"),z&&(z.remove(),z=null);const t=document.getElementById("destination-coord-display");t&&t.remove(),ce&&(ce.style.display="",ce=null)}document.addEventListener("DOMContentLoaded",()=>{mt();const e=document.getElementById("pdf-canvas"),l=document.getElementById("pdf-canvas-wrapper"),t=document.getElementById("cancel-picking-btn");let n=null;l?.addEventListener("mousemove",a=>{if(!pe||!e)return;const o=e.getBoundingClientRect(),f=a.clientX-o.left,d=a.clientY-o.top;n||(n=document.createElement("div"),n.className="coordinate-tooltip",l.appendChild(n)),n.textContent=`X: ${Math.round(f)}, Y: ${Math.round(d)} `,n.style.left=a.clientX-o.left+15+"px",n.style.top=a.clientY-o.top+15+"px"}),l?.addEventListener("mouseleave",()=>{n&&(n.remove(),n=null)}),e?.addEventListener("click",async a=>{if(!pe||!ge||!k||!e||!l)return;const o=e.getBoundingClientRect(),f=a.clientX-o.left,d=a.clientY-o.top;let c=Xe;c||(c=(await k.getPage(P)).getViewport({scale:H}));const m=c.width/o.width,I=c.height/o.height,p=f*m,w=c.height-d*I;z&&z.remove();const L=document.getElementById("destination-coord-display");L&&L.remove(),z=document.createElement("div"),z.className="destination-marker",z.innerHTML=`
  <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
    <circle cx="12" cy="12" r="10" fill="#3b82f6" fill-opacity="0.2" />
      <path d="M12 2 L12 22 M2 12 L22 12" />
        <circle cx="12" cy="12" r="2" fill="#3b82f6" />
          </svg>
            `;const u=e.getBoundingClientRect(),v=l.getBoundingClientRect();z.style.position="absolute",z.style.left=f+u.left-v.left+"px",z.style.top=d+u.top-v.top+"px",l.appendChild(z);const h=document.createElement("div");h.id="destination-coord-display",h.className="absolute bg-blue-500 text-white px-2 py-1 rounded text-xs font-mono z-50 pointer-events-none",h.style.left=f+u.left-v.left+20+"px",h.style.top=d+u.top-v.top-30+"px",h.textContent=`X: ${Math.round(p)}, Y: ${Math.round(w)} `,l.appendChild(h),ge(P,p,w),setTimeout(()=>{V()},500)}),t&&t.addEventListener("click",()=>{V()})});function oe(e){return new Promise(l=>{const t=document.createElement("div");t.className="modal-overlay";const n=document.createElement("div");n.className="modal-content",n.innerHTML=`
  <div class="p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
      <p class="text-gray-600 mb-6">${e}</p>
        <div class="flex gap-2 justify-end">
          <button id="modal-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</button>
            <button id="modal-confirm" class="px-4 py-2 rounded btn-gradient text-white">Confirm</button>
              </div>
              </div>
                `,t.appendChild(n),O?.appendChild(t),n.querySelector("#modal-cancel")?.addEventListener("click",()=>{O?.removeChild(t),l(!1)}),n.querySelector("#modal-confirm")?.addEventListener("click",()=>{O?.removeChild(t),l(!0)}),t.addEventListener("click",a=>{a.target===t&&(O?.removeChild(t),l(!1))})})}function D(e,l){return new Promise(t=>{const n=document.createElement("div");n.className="modal-overlay";const a=document.createElement("div");a.className="modal-content",a.innerHTML=`
              <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">${e}</h3>
                  <p class="text-gray-600 mb-6">${l}</p>
                    <div class="flex justify-end">
                      <button id="modal-ok" class="px-4 py-2 rounded btn-gradient text-white">OK</button>
                        </div>
                        </div>
                          `,n.appendChild(a),O?.appendChild(n),a.querySelector("#modal-ok")?.addEventListener("click",()=>{O?.removeChild(n),t(!0)}),n.addEventListener("click",o=>{o.target===n&&(O?.removeChild(n),t(!0))})})}function Jt(){window.innerWidth>=1024&&(ve?.classList.remove("hidden"),be?.classList.remove("hidden"),F?.classList.remove("bg-indigo-600","text-white"),F?.classList.add("text-gray-300"),J?.classList.remove("bg-indigo-600","text-white"),J?.classList.add("text-gray-300"))}window.addEventListener("resize",Jt);F?.addEventListener("click",()=>{ve?.classList.remove("hidden"),be?.classList.add("hidden"),F?.classList.add("bg-indigo-600","text-white"),F?.classList.remove("text-gray-300"),J?.classList.remove("bg-indigo-600","text-white"),J?.classList.add("text-gray-300")});J?.addEventListener("click",()=>{ve?.classList.add("hidden"),be?.classList.remove("hidden"),J?.classList.add("bg-indigo-600","text-white"),J?.classList.remove("text-gray-300"),F?.classList.remove("bg-indigo-600","text-white"),F?.classList.add("text-gray-300")});St?.addEventListener("click",e=>{e.stopPropagation(),ne?.classList.toggle("hidden"),le?.classList.add("hidden")});Ct?.addEventListener("click",e=>{e.stopPropagation(),le?.classList.toggle("hidden"),ne?.classList.add("hidden")});document.addEventListener("click",()=>{ne?.classList.add("hidden"),le?.classList.add("hidden")});let C=null,k=null,P=1,ae="",g=[],j=[],N=-1,_="",Q=null,ee=null,K=!1;const E=new Set,A=new Set;function M(){j=j.slice(0,N+1),j.push(JSON.parse(JSON.stringify(g))),N++,Se()}function Je(){N>0&&(N--,g=JSON.parse(JSON.stringify(j[N])),x(),Se())}function Re(){N<j.length-1&&(N++,g=JSON.parse(JSON.stringify(j[N])),x(),Se())}function Se(){we&&(we.disabled=N<=0),Le&&(Le.disabled=N>=j.length-1)}we?.addEventListener("click",Je);Le?.addEventListener("click",Re);Lt?.addEventListener("click",async()=>{await oe("Reset and go back to file uploader? All unsaved changes will be lost.")&&He()});It?.addEventListener("click",async()=>{if(g.length===0){await D("Info","No bookmarks to delete.");return}await oe(`Delete all ${g.length} bookmark(s) ? `)&&(g=[],E.clear(),G(),M(),x())});function He(){C=null,k=null,P=1,ae="",g=[],j=[],N=-1,_="",Q=null,ee=null,K=!1,E.clear(),A.clear(),fe&&(fe.value=""),ke&&(ke.value=""),Ee&&(Ee.value=""),Ye?.classList.add("hidden"),Fe?.classList.remove("hidden"),ve?.classList.remove("hidden"),be?.classList.add("hidden"),F?.classList.add("bg-indigo-600","text-white"),F?.classList.remove("text-gray-300"),J?.classList.remove("bg-indigo-600","text-white"),J?.classList.add("text-gray-300")}document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="z"&&!e.shiftKey?(e.preventDefault(),Je()):(e.key==="z"&&e.shiftKey||e.key==="y")&&(e.preventDefault(),Re()))});Mt?.addEventListener("change",e=>{K=e.target.checked,K||(E.clear(),G()),Be?.classList.toggle("hidden",!K||E.size===0),x()});function G(){Oe&&(Oe.textContent=String(E.size)),K&&Be?.classList.toggle("hidden",E.size===0)}Xt?.addEventListener("click",()=>{const e=l=>{let t=[];return l.forEach(n=>{t.push(n.id),n.children.length>0&&(t=t.concat(e(n.children)))}),t};e(g).forEach(l=>E.add(l)),G(),x()});Yt?.addEventListener("click",()=>{E.clear(),G(),x()});Tt?.addEventListener("change",e=>{const l=e.target;if(l.value&&E.size>0){const t=l.value==="null"?null:l.value;We(n=>n.color=t),l.value=""}});Ot?.addEventListener("change",e=>{const l=e.target;if(l.value&&E.size>0){const t=l.value==="null"?null:l.value;We(n=>n.style=t),l.value=""}});qt?.addEventListener("click",async()=>{if(E.size===0||!await oe(`Delete ${E.size} bookmark(s) ? `))return;const l=t=>t.filter(n=>E.has(n.id)?!1:(n.children=l(n.children),!0));g=l(g),E.clear(),G(),M(),x()});function We(e){const l=t=>t.map(n=>(E.has(n.id)&&e(n),n.children=l(n.children),n));g=l(g),M(),x()}Ft?.addEventListener("click",()=>{A.clear(),x()});jt?.addEventListener("click",()=>{const e=l=>{l.forEach(t=>{t.children.length>0&&(A.add(t.id),e(t.children))})};e(g),x()});function Rt(e){if(!ie)return;ie.innerHTML="",ie.classList.remove("hidden");const l=document.createElement("div");l.className="flex items-center justify-between bg-gray-700 p-3 rounded-lg text-sm";const t=document.createElement("span");t.className="truncate font-medium text-gray-200",t.textContent=e.name;const n=document.createElement("span");n.className="flex-shrink-0 ml-4 text-gray-400",n.textContent=rt(e.size),l.append(t,n),ie.appendChild(l)}fe?.addEventListener("change",Ht);async function Ht(e){const l=e?e.target.files?.[0]:fe?.files?.[0];if(!l)return;Pe?.classList.remove("hidden"),ae=l.name.replace(".pdf",""),Te&&(Te.textContent=ot(l.name)),Rt(l);const t=await l.arrayBuffer();if(P=1,g=[],j=[],N=-1,E.clear(),A.clear(),C=await at.load(t,{ignoreEncryption:!0}),k=await st({data:new Uint8Array(t)}).promise,U&&(U.max=String(k.numPages)),Ye?.classList.remove("hidden"),Fe?.classList.add("hidden"),yt?.checked){const a=await nt();a.length>0&&(g=a)}Q?(g=Q,Q=null):ee&&(g=ee,ee=null),M(),x(),q(P),ye({icons:he}),Pe?.classList.add("hidden")}ke?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();Q=tt(n),await D("CSV Loaded",`Loaded ${Q.length} bookmarks from CSV. Now upload your PDF.`)});Ee?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{ee=JSON.parse(n),await D("JSON Loaded","Loaded bookmarks from JSON. Now upload your PDF.")}catch{await D("Error","Invalid JSON format")}});async function q(e,l=null,t=null,n=null){if(!k||!Z||!y)return;const a=await k.getPage(e);let o=H;l!==null&&l!==""&&l!=="0"&&(o=parseFloat(l)/100);const f=window.devicePixelRatio||1,d=a.getViewport({scale:o});if(Xe=d,Z.height=d.height*f,Z.width=d.width*f,Z.style.width=d.width+"px",Z.style.height=d.height+"px",y.scale(f,f),await a.render({canvasContext:y,viewport:d,canvas:Z}).promise,t!==null&&n!==null){const c=t,m=d.height-n;y.save(),y.strokeStyle="#3b82f6",y.fillStyle="#3b82f6",y.lineWidth=3,y.shadowBlur=10,y.shadowColor="rgba(59, 130, 246, 0.5)",y.beginPath(),y.arc(c,m,12,0,2*Math.PI),y.fill(),y.shadowBlur=0,y.beginPath(),y.moveTo(c-15,m),y.lineTo(c+15,m),y.moveTo(c,m-15),y.lineTo(c,m+15),y.stroke(),y.beginPath(),y.arc(c,m,6,0,2*Math.PI),y.fill(),y.stroke();const I=`X: ${Math.round(t)}, Y: ${Math.round(n)} `;y.font="bold 12px monospace";const w=y.measureText(I).width,L=18;y.fillStyle="rgba(59, 130, 246, 0.95)",y.fillRect(c+18,m-25,w+10,L),y.fillStyle="white",y.fillText(I,c+23,m-10),y.restore()}ht.textContent=`Page ${e} / ${k.numPages}`,U&&(U.value=String(e)),P=e,Me&&(Me.textContent=String(e))}async function Ze(e,l,t,n){await q(e,n,l,t)}vt?.addEventListener("click",()=>{P>1&&q(P-1)});bt?.addEventListener("click",()=>{k&&P<k.numPages&&q(P+1)});je?.addEventListener("click",()=>{if(!k||!U)return;const e=parseInt(U.value);e>=1&&e<=k.numPages&&q(e)});U?.addEventListener("keypress",e=>{e.key==="Enter"&&je?.click()});function xe(){$e&&($e.textContent=`${Math.round(H*100)}%`)}xt?.addEventListener("click",()=>{H=Math.min(H+.05,2),xe(),q(P)});kt?.addEventListener("click",()=>{H=Math.max(H-.05,.25),xe(),q(P)});Et?.addEventListener("click",async()=>{k&&(H=1,xe(),q(P))});xe();Bt?.addEventListener("input",e=>{_=e.target.value.toLowerCase(),x()});function _e(e,l){for(let t=0;t<e.length;t++){if(e[t].id===l)return e.splice(t,1),!0;if(_e(e[t].children,l))return!0}return!1}function Ke(e,l=0){let t=[];for(const n of e)t.push({...n,level:l}),n.children.length>0&&(t=t.concat(Ke(n.children,l+1)));return t}function Ue(e,l){return!l||e.title.toLowerCase().includes(l)?!0:e.children.some(t=>Ue(t,l))}function Ge(e,l=null,t=!1){new ct(e,{group:t?"top-level-only":"nested-level-"+(l?l.id:"none"),animation:150,handle:"[data-drag-handle]",ghostClass:"sortable-ghost",dragClass:"sortable-drag",forceFallback:!0,fallbackTolerance:3,onEnd:function(n){try{if(n.oldIndex===n.newIndex){x();return}const a=JSON.parse(JSON.stringify(g));if(t&&n.oldIndex!==void 0&&n.newIndex!==void 0){const o=a.splice(n.oldIndex,1)[0];a.splice(n.newIndex,0,o),g=a}else if(l&&n.oldIndex!==void 0&&n.newIndex!==void 0){const o=Qe(a,l.id);if(o&&o.children){const f=o.children.splice(n.oldIndex,1)[0];o.children.splice(n.newIndex,0,f),g=a}else{x();return}}M(),x()}catch(a){console.error("Error in drag and drop:",a),N>0&&(g=JSON.parse(JSON.stringify(j[N]))),x()}}})}function Qe(e,l){if(!e||!Array.isArray(e))return null;for(const t of e){if(t.id===l)return t;if(t.children&&t.children.length>0){const n=Qe(t.children,l);if(n)return n}}return null}function Wt(e){return e==="bold"?"font-bold":e==="italic"?"italic":e==="bold-italic"?"font-bold italic":""}function Zt(e){return e?typeof e=="string"&&e.startsWith("#")?"":gt[e]||"text-gray-700":"text-gray-700"}function x(){if(!re)return;re.innerHTML="";const e=_?g.filter(l=>Ue(l,_)):g;if(e.length===0)ze?.classList.remove("hidden");else{ze?.classList.add("hidden");for(const l of e)re.appendChild(Ve(l));Ge(re,null,!0)}ye({icons:he}),G()}function Ve(e,l=0){if(!e||!e.id)return console.error("Invalid node:",e),document.createElement("li");const t=document.createElement("li");t.dataset.bookmarkId=String(e.id),t.className="group";const n=e.children&&Array.isArray(e.children)&&e.children.length>0,a=A.has(e.id),o=E.has(e.id),d=(!_||e.title.toLowerCase().includes(_))&&_?"bg-yellow-100":"",c=e.color&&typeof e.color=="string"&&pt[e.color]||"",m=Wt(e.style),I=Zt(e.color),p=document.createElement("div");if(p.className=`flex items-center gap-2 p-2 rounded border border-gray-200 ${c} ${d} ${o?"ring-2 ring-blue-500":""} hover:bg-gray-50`,K){const i=document.createElement("input");i.type="checkbox",i.checked=o,i.className="w-4 h-4 flex-shrink-0",i.addEventListener("click",r=>{r.stopPropagation(),E.has(e.id)?E.delete(e.id):E.add(e.id),G(),i.checked=E.has(e.id),Be?.classList.toggle("hidden",!K||E.size===0)}),p.appendChild(i)}const w=document.createElement("div");if(w.dataset.dragHandle="true",w.className="cursor-move flex-shrink-0",w.innerHTML='<i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>',p.appendChild(w),n){const i=document.createElement("button");i.className="p-0 flex-shrink-0",i.innerHTML=a?'<i data-lucide="chevron-right" class="w-4 h-4"></i>':'<i data-lucide="chevron-down" class="w-4 h-4"></i>',i.addEventListener("click",r=>{r.stopPropagation(),A.has(e.id)?A.delete(e.id):A.add(e.id),x()}),p.appendChild(i)}else{const i=document.createElement("div");i.className="w-4 flex-shrink-0",p.appendChild(i)}const L=document.createElement("div");L.className="flex-1 min-w-0 cursor-pointer";const u=e.color&&typeof e.color=="string"&&e.color.startsWith("#")?`style="color: ${e.color}"`:"",h=e.destX!==null||e.destY!==null||e.zoom!==null?'<i data-lucide="crosshair" class="w-3 h-3 inline-block ml-1 text-blue-500"></i>':"";L.innerHTML=`
                <span class="text-sm block ${m} ${I}" ${u}>${et(e.title)}${h}</span>
                <span class="text-xs text-gray-500">Page ${e.page}</span>
            `,L.addEventListener("click",async()=>{e.destX!==null||e.destY!==null||e.zoom!==null?(await Ze(e.page,e.destX,e.destY,e.zoom),setTimeout(()=>{e.zoom!==null&&e.zoom!==""&&e.zoom!=="0"?setTimeout(()=>{q(e.page)},1e3):q(e.page)},2e3)):q(e.page),window.innerWidth<1024&&F?.click()}),p.appendChild(L);const T=document.createElement("div");T.className="flex gap-1 flex-shrink-0";const X=document.createElement("button");X.className="p-1 hover:bg-gray-200 rounded text-gray-700",X.title="Add child",X.innerHTML='<i data-lucide="plus" class="w-4 h-4"></i>',X.addEventListener("click",async i=>{i.stopPropagation();const r=await qe("Add Child Bookmark",[{type:"text",name:"title",label:"Title",placeholder:"Enter bookmark title"}]);r&&r.title&&(e.children.push({id:Date.now()+Math.random(),title:te(String(r.title)),page:P,children:[],color:null,style:null,destX:null,destY:null,zoom:null}),A.delete(e.id),M(),x())}),T.appendChild(X);const R=document.createElement("button");R.className="p-1 hover:bg-gray-200 rounded text-gray-700",R.title="Edit",R.innerHTML='<i data-lucide="edit-2" class="w-4 h-4"></i>',R.addEventListener("click",async i=>{i.stopPropagation();const r=await qe("Edit Bookmark",[{type:"text",name:"title",label:"Title",placeholder:"Enter bookmark title"},{type:"select",name:"color",label:"Color",options:[{value:"",label:"None"},{value:"red",label:"Red"},{value:"blue",label:"Blue"},{value:"green",label:"Green"},{value:"yellow",label:"Yellow"},{value:"purple",label:"Purple"},{value:"custom",label:"Custom..."}]},{type:"select",name:"style",label:"Style",options:[{value:"",label:"Normal"},{value:"bold",label:"Bold"},{value:"italic",label:"Italic"},{value:"bold-italic",label:"Bold & Italic"}]},{type:"destination",name:"destination",label:"Destination",page:e.page,maxPages:k?k.numPages:1},{type:"preview",label:"Preview"}],{title:e.title,color:e.color||"",style:e.style||"",destPage:e.page,destX:e.destX,destY:e.destY,zoom:e.zoom});r&&(e.title=te(String(r.title||"")),e.color=r.color||null,e.style=r.style||null,r.destPage!==null&&r.destPage!==void 0&&(e.page=r.destPage,e.destX=r.destX??null,e.destY=r.destY??null,e.zoom=r.zoom??null),M(),x())}),T.appendChild(R);const s=document.createElement("button");if(s.className="p-1 hover:bg-gray-200 rounded text-red-600",s.title="Delete",s.innerHTML='<i data-lucide="trash-2" class="w-4 h-4"></i>',s.addEventListener("click",async i=>{i.stopPropagation(),await oe(`Delete "${e.title}"?`)&&(_e(g,e.id),M(),x())}),T.appendChild(s),p.appendChild(T),t.appendChild(p),n&&!a){const i=document.createElement("ul");i.className="child-container space-y-2";const r=JSON.parse(JSON.stringify(e));for(const b of e.children)b&&b.id&&i.appendChild(Ve(b,l+1));t.appendChild(i),Ge(i,r,!1)}return t}Ae?.addEventListener("click",async()=>{const e=de?.value.trim();if(!e){await D("Error","Please enter a title.");return}g.push({id:Date.now(),title:e,page:P,children:[],color:null,style:null,destX:null,destY:null,zoom:null}),M(),x(),de&&(de.value="")});de?.addEventListener("keypress",e=>{e.key==="Enter"&&Ae?.click()});function et(e){return it(e)}Pt?.addEventListener("click",()=>{ue?.click(),ne?.classList.add("hidden")});ue?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text(),a=tt(n);a.length>0&&(g=a,M(),x(),await D("Success",`Imported ${a.length} bookmarks!`)),ue&&(ue.value="")});Nt?.addEventListener("click",()=>{if(le?.classList.add("hidden"),g.length===0){D("Error","No bookmarks to export!");return}const l=`title,page,level
`+Ke(g).map(n=>`"${n.title.replace(/"/g,'""')}",${n.page},${n.level}`).join(`
`),t=new Blob([l],{type:"text/csv"});Ie(t,`${ae}-bookmarks.csv`)});function tt(e){const l=e.trim().split(`
`).slice(1),t=[],n=[{children:t,level:-1}];for(const a of l){const o=a.match(/^"(.+)",(\d+),(\d+)$/)||a.match(/^([^,]+),(\d+),(\d+)$/);if(!o)continue;const[,f,d,c]=o,m={id:Date.now()+Math.random(),title:te(f.replace(/""/g,'"')),page:parseInt(d),children:[],color:null,style:null,destX:null,destY:null,zoom:null},I=parseInt(c);for(;n[n.length-1].level>=I;)n.pop();n[n.length-1].children.push(m),n.push({children:m.children,level:I})}return t}Dt?.addEventListener("click",()=>{me?.click(),ne?.classList.add("hidden")});me?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{let a=function(f){if(f)for(const d of f)d.title&&(d.title=te(d.title)),d.children&&a(d.children)};const o=JSON.parse(n);a(o),g=o,M(),x(),await D("Success","Bookmarks imported from JSON!")}catch{await D("Error","Invalid JSON format")}me&&(me.value="")});$t?.addEventListener("click",()=>{if(le?.classList.add("hidden"),g.length===0){D("Error","No bookmarks to export!");return}const e=JSON.stringify(g,null,2),l=new Blob([e],{type:"application/json"});Ie(l,`${ae}-bookmarks.json`)});zt?.addEventListener("click",async()=>{if(!C)return;const e=await nt();e.length>0?await oe(`Found ${e.length} existing bookmarks. Replace current bookmarks?`)&&(g=e,M(),x()):await D("Info","No existing bookmarks found in this PDF.")});function te(e){return typeof e=="string"?e.replace(/[\x00-\x1F\x7F-\x9F]/g,"").trim():e}async function nt(){try{if(!k)return[];const e=await k.getOutline();if(!e)return[];async function l(n){let a=0,o=null,f=null,d=null;try{let p=n.dest;if(typeof p=="string"&&k&&(p=await k.getDestination(p)),Array.isArray(p)&&k){const w=p[0];if(a=await k.getPageIndex(w),p.length>2){const L=p[2],u=p[3],v=p[4];typeof L=="number"&&(o=L),typeof u=="number"&&(f=u),typeof v=="number"&&(d=String(Math.round(v*100)))}}}catch(p){console.warn("Error resolving destination:",p)}let c=null;if(n.color){const[p,w,L]=n.color,u=p/255,v=w/255,h=L/255;u>.8&&v<.3&&h<.3?c="red":u<.3&&v<.3&&h>.8?c="blue":u<.3&&v>.8&&h<.3?c="green":u>.8&&v>.8&&h<.3?c="yellow":u>.5&&v<.5&&h>.5&&(c="purple")}let m=null;n.bold&&n.italic?m="bold-italic":n.bold?m="bold":n.italic&&(m="italic");const I={id:Date.now()+Math.random(),title:te(n.title),page:a+1,children:[],color:c,style:m,destX:o,destY:f,zoom:d};if(n.items&&n.items.length>0)for(const p of n.items){const w=await l(p);I.children.push(w)}return I}const t=[];for(const n of e){const a=await l(n);t.push(a)}return t}catch(e){return console.error("Error extracting bookmarks:",e),[]}}Ne&&Ne.addEventListener("click",()=>{window.location.href="/bentopdf/"});De&&De.addEventListener("click",()=>{window.location.href="/bentopdf/"});wt?.addEventListener("click",async()=>{if(!C)return;const e=C.getPages(),l=C.context.obj({}),t=C.context.register(l);function n(a,o){const f=[];for(let d=0;d<a.length;d++){const c=a[d],m=C.context.obj({}),I=C.context.register(m);m.set(B.of("Title"),dt.fromText(c.title)),m.set(B.of("Parent"),o);const p=Math.max(0,Math.min(c.page-1,e.length-1)),w=e[p].ref;let L;if(c.destX!==null||c.destY!==null||c.zoom!==null){const u=c.destX!==null?se.of(c.destX):null,v=c.destY!==null?se.of(c.destY):null;let h=null;c.zoom!==null&&c.zoom!==""&&c.zoom!=="0"&&(h=se.of(parseFloat(c.zoom)/100)),L=C.context.obj([w,B.of("XYZ"),u,v,h])}else L=C.context.obj([w,B.of("XYZ"),null,null,null]);if(m.set(B.of("Dest"),L),c.color){let u;const v=c.color;if(v.startsWith("#")){const{r:h,g:T,b:X}=ut(v);u=[h,T,X]}else Ce[v]&&(u=Ce[v]);if(u){const h=C.context.obj(u);m.set(B.of("C"),h)}}if(c.style){let u=0;c.style==="italic"?u=1:c.style==="bold"?u=2:c.style==="bold-italic"&&(u=3),u>0&&m.set(B.of("F"),se.of(u))}if(c.children.length>0){const u=n(c.children,I);u.length>0&&(m.set(B.of("First"),u[0].ref),m.set(B.of("Last"),u[u.length-1].ref),m.set(B.of("Count"),C.context.obj(u.length)))}d>0&&(m.set(B.of("Prev"),f[d-1].ref),f[d-1].dict.set(B.of("Next"),I)),f.push({ref:I,dict:m})}return f}try{const a=n(g,t);a.length>0&&(l.set(B.of("Type"),B.of("Outlines")),l.set(B.of("First"),a[0].ref),l.set(B.of("Last"),a[a.length-1].ref),l.set(B.of("Count"),C.context.obj(a.length))),C.catalog.set(B.of("Outlines"),t);const o=await C.save(),f=new Blob([new Uint8Array(o)],{type:"application/pdf"});Ie(f,`${ae}-bookmarked.pdf`),await D("Success","PDF saved successfully!"),setTimeout(()=>{He()},500)}catch(a){console.error(a),await D("Error","Error saving PDF. Check console for details.")}});
