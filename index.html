<!DOCTYPE html>
<html lang="en,zh-Hans,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="9g-E_K0GEppNWOItj0YYJV_1UbSLdVFrKOhHSPLkJcM">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kevinsj.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="A blog about all things tech.">
<meta property="og:type" content="website">
<meta property="og:title" content="Kevin Jiang&#39;s Technical Blog">
<meta property="og:url" content="http://kevinsj.github.io/index.html">
<meta property="og:site_name" content="Kevin Jiang&#39;s Technical Blog">
<meta property="og:description" content="A blog about all things tech.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="KevinSJ">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://kevinsj.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Kevin Jiang's Technical Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Kevin Jiang's Technical Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Kevin Jiang's Technical Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2022/05/21/neovim-tricks-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/21/neovim-tricks-1/" class="post-title-link" itemprop="url">Tips for using NeoVim as devtool - 1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 05-21-2022 15:14:02 / Modified: 18:12:31" itemprop="dateCreated datePublished" datetime="2022-05-21T15:14:02+12:00">05-21-2022</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>As a developer, one of the most important things is to find the right tool to write code with. To me, that means this tool needs to be lightweight, portable, and most importantly reliable.</p>
<h3 id="Why-VSCode-is-not-for-me"><a href="#Why-VSCode-is-not-for-me" class="headerlink" title="Why VSCode is not for me"></a>Why VSCode is not for me</h3><p>VSCode, aka Visual Studio Code, is a code editor developed by Microsoft. It is based on top of the Atom editor that was previously developed by GitHub. As a full stack developer whose main language is JavaScript&#x2F;TypeScript, I was told to use VSCode when I joined the company. However, as a long-time vim user, I still use the vim mappings when I am using VSCode. This is all done through plugin&#x2F;extensions. This seems to be okay at first, but over time, I really find VSCode annoying to use and I simply can’t tolerate it.</p>
<p>The first thing is that contrary to most popular belief, VSCode is <strong>NOT</strong> an open source product. Yes, part of the source of VSCode <strong>is</strong> open-sourced, but the VSCode you downloaded from Microsoft website is not. They have put some proprietary stuff into the end product and I’m not a big fan of that. There are ways to get around this, namely, there are several truly open source edition of VSCode, the one I used to use is called VSCodium, but then you will lose access to the extensions market provided by Microsoft.</p>
<p>Another thing that annoys me is that VSCode or any product that based on VSCode is just too slow and resource intensive – they are just an electron app running on another Chromium based browser. Having one Chrome is enough for me, so thank you Microsoft (I tried to avoid electron based apps as much as possible, for example, I use web version of Teams, rather than the app one)</p>
<h3 id="How-NeoVim-x2F-Vim-fits-in"><a href="#How-NeoVim-x2F-Vim-fits-in" class="headerlink" title="How NeoVim&#x2F;Vim fits in"></a>How NeoVim&#x2F;Vim fits in</h3><p>I had been a long-time vim user, I first began using vim when I was studying computer science at the university. But I had never tried to use vim as my daily tool for software development before 2021. In February of 2021, we had a new dev joining my team. To my surprise, he was using vim (more precisely NeoVim) as his daily driver. This inspired me, and I started to explore ways to use VIM as well. At the time of this writing, I have been using NeoVim as my daily driver for more than a year now. To me, the experience has never been more pleasant. So I would just like to share a few tips on how I use it daily.</p>
<h3 id="Run-tests-without-leaving-vim"><a href="#Run-tests-without-leaving-vim" class="headerlink" title="Run tests without leaving vim"></a>Run tests without leaving vim</h3><p>Suppose you currently have a test file opened in you vim, and you would like to run all the tests within this file, what would you do?</p>
<h3 id="Solution-1-Open-a-new-terminal"><a href="#Solution-1-Open-a-new-terminal" class="headerlink" title="Solution 1: Open a new terminal"></a>Solution 1: Open a new terminal</h3><p>I think most people would open a new window or a new split in Tmux and start the command <code>yarn test filename</code>. At least that was what I was doing when I first encountered this problem. Well, obviously, this is not the ideal solution, because this would be really interruptive, you would have to switch between either a different terminal or a Tmux window.</p>
<h3 id="Solution-2-Run-the-command-within-vim-itself"><a href="#Solution-2-Run-the-command-within-vim-itself" class="headerlink" title="Solution 2: Run the command within vim itself"></a>Solution 2: Run the command within vim itself</h3><p>After several days of using solution 1, I was really tired of it. Switching between different terminal is just too slow and interruptive. So this is when I come to the second solution: in normal mode, use <code>:!yarn test %</code>. Okay, this works, I don’t have to leave VIM each time I want to run the test. But now the problem is that running this command is blocking, meaning you can’t edit the file while the test is running. This is fine if the test is not long or you are just running a single test using <code>it.only</code> or something like that. But if the text is long enough, it might be 2 or 3 minutes before you can do anything again, which is quite annoying to me.</p>
<h3 id="Solution-3-Using-Vim’s-terminal-mode"><a href="#Solution-3-Using-Vim’s-terminal-mode" class="headerlink" title="Solution 3: Using Vim’s terminal mode"></a>Solution 3: Using Vim’s terminal mode</h3><p>Starting from Vim 8.0, Vim adds a built-in terminal mode, which is quite handy to use. Once I found this out, I started to use <code>:sp term://yarn test %</code>, this will create a new <strong>horizontal</strong> split and start a terminal that runs <code>yarn test %</code>, while the tests are running, you can still do whatever you want to do and will not be blocked by the testing itself.<br>Once the command is finished, you will see the command exit in that window.</p>
<h3 id="Solution-3-1-Shortcut-to-Vim-command"><a href="#Solution-3-1-Shortcut-to-Vim-command" class="headerlink" title="Solution 3.1: Shortcut to Vim command"></a>Solution 3.1: Shortcut to Vim command</h3><p>Solution 3 is almost perfect, except I use this command too frequently that typing this whole command becomes a pain. So I had to find some way to improve my experience. And this all comes down to mapping this command to something shorter (at least that was what I was thinking at first). So I added the following to my vimrc file <code>cmap rt!! !yarn test % &lt;CR&gt;</code> this saves lots of keystrokes, but still, I need to type it every single time I want to use it. I still feel there’s space for improvements. </p>
<h3 id="Final-Solution-Key-mapping"><a href="#Final-Solution-Key-mapping" class="headerlink" title="Final Solution: Key mapping"></a>Final Solution: Key mapping</h3><p>Based on function 3.1, I started to think if I can map the command to a leader key, it turned out I definitely can, with this <code>map &lt;buffer&gt; &lt;silent&gt; &lt;nowait&gt; &lt;Leader&gt;rt :execute &#39;sp term://yarn test %&#39;&lt;CR&gt;</code></p>
<h3 id="Afterthoughts"><a href="#Afterthoughts" class="headerlink" title="Afterthoughts"></a>Afterthoughts</h3><p>There are several caveats with the above solution.<br>First, this mapping will exist in every file type which is not ideal, cause you don’t want to use yarn to test a GO file for example. Therefore, I moved this command to a separate file under the <code>ftplugin</code> folder and call it <code>typescript_mappings.vim</code>.<br>Second, you will always have to locate the test file before you can run the test. This is not a deal breaker, but it is still not perfect. Usually you would refactor a simple function within a file and all you care about is whether the corresponding tests passes, you don’t necessarily need to edit the file or care about where the file is. This prompts me to turn this whole thing into a vimscript function<br>Here goes the function I created: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">map &lt;leader&gt;T :Ft&lt;CR&gt;</span><br><span class="line"></span><br><span class="line">if exists(&#x27;*FindTest&#x27;)</span><br><span class="line">    finish</span><br><span class="line">endif</span><br><span class="line">command! -nargs=? Ft call FindTest(&lt;q-args&gt;)</span><br><span class="line">fun! FindTest(...)</span><br><span class="line">  set path+=**</span><br><span class="line"></span><br><span class="line">  let fileName = expand(&#x27;%:t:r&#x27;) . &#x27;.test.ts&#x27;</span><br><span class="line">  execute &#x27;tabnew &#x27;</span><br><span class="line">  execute &#x27;find &#x27;. fileName</span><br><span class="line">  execute &#x27;split term://yarn test &#x27;. fileName . &#x27; --watch&#x27;</span><br><span class="line">endfun</span><br></pre></td></tr></table></figure>
<p>This function first set the look path to all the directories recursively, then it expand to the filename excluding the extension, then add .test.ts to it. After that, it opens a new tab, open the test file and then create a terminal, yarn test that file in watch mode.</p>
<p>I put this file under the ftplugin again, but one issue is that because the both the file found and the current file are of the same file type, this means the script will be sourced twice. So I had to put the <code>if exists</code> check. I map this command to <leader> T but you can tailor that to your liking.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2022/03/06/hide-phone-number-when-making-calls/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/06/hide-phone-number-when-making-calls/" class="post-title-link" itemprop="url">Hide Phone Number when making calls</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 03-06-2022 17:43:57 / Modified: 18:00:18" itemprop="dateCreated datePublished" datetime="2022-03-06T17:43:57+13:00">03-06-2022</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>⚠ Hiding phone numbers may not be legal in some places, and even if you hide your number, you mobile operator <strong>WILL</strong> (of course) see your number. Use the method described in this article at your own risk!</p>
<p>In Android&#x2F;iOS, there is a way to hide your phone numbers on outgoing phone calls.</p>
<ul>
<li>For most Android phones, this setting is somewhere under <strong>Call Settings</strong> -&gt; <strong>Additional settings</strong> in the phone app. </li>
<li>In most countries, it is by law that the mobile network operator provide an option to hide your number. if you choose the <strong>Hide number</strong> options, you number will always be hidden. <em><strong>This is a setting at the operator level, meaning even people who have your info in their contacts will not be able to identify who you are.</strong></em></li>
<li>To most people, you would not want to hide your mobile number when calling someone you know. But you <strong>do</strong> want to do so, if you are calling someone you are not familiar with, a business for example.</li>
<li>Luckily, there is a way to hide your phone numbers temporarily, if you wish to do so. It differs by country though:<ul>
<li>In the U.S, if you want to hide your number, you can add <code>*67</code> before the number you are calling.</li>
<li>In New Zealand, you can use<ul>
<li>when <code>*31#</code> is added to the number you are trying to call, you number will be shown, disregarding the setting.</li>
<li>when <code>#31#</code> is added to the number you are trying to call, you number will be hidden, disregarding the setting</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/12/02/Fixing-issue-on-Xorg-and-VNC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/02/Fixing-issue-on-Xorg-and-VNC/" class="post-title-link" itemprop="url">Fixing issue on Xorg and VNC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 12-02-2021 22:48:35" itemprop="dateCreated datePublished" datetime="2021-12-02T22:48:35+13:00">12-02-2021</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 12-03-2021 23:32:43" itemprop="dateModified" datetime="2021-12-03T23:32:43+13:00">12-03-2021</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Yesterday morning, when I woke up, I faced a serious issue on my laptop which has Manjaro Linux installed – the X server can not be started.</p>
<h3 id="Locating-the-problem"><a href="#Locating-the-problem" class="headerlink" title="Locating the problem"></a>Locating the problem</h3><p>It took me some time to get my head around and locate the root cause. The first thing I tried is obviously force reboot several times, it turned out this did not help at all! Reboot will not solve everything.™<br>The next thing I tried was the fallback initramfs mode. I don’t really understand what it does, but tried it anyway. And unfortunately, that does not work either.<br>At this point,the only option left for me to try is recovery mode. And it turned out to be working correctly. As root user in the recovery mode, I issued the following command <code>systemctl set-default multi-user.target</code>, this makes the tty the default target rather than the graphical interface. Another reboot, and I got into the terminal.<br>Once in terminal, I immediately tried <code>startx</code>, this failed due to some wired permission issue, and with <code>sudo startx</code>, the command failed as well. Looking at the Xorg log, I noticed that the start process stops at: <code>(II) Initializing extension VNC</code></p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>The obvious solution at this point is to uninstall the VNC module that is causing the issue, so <code>sudo pacman --remove --recursive tigervnc</code> was the way to go. And it did fix the issue. So what I had to do was reset it back to graphical interface start with <code>systemctl set-default graphical.target</code>.</p>
<h3 id="Findings-and-thoughts"><a href="#Findings-and-thoughts" class="headerlink" title="Findings and thoughts"></a>Findings and thoughts</h3><p>By doing some more research online, I have found that this issue was actually solved by TigerVNC as can be seen from <a target="_blank" rel="noopener" href="https://github.com/TigerVNC/tigervnc/issues/1373">this</a> closed issue. The issue that most likely to have happened here is that Arch Linux package builder did not provide the up-to-date build for the package which resulted in the package does not included the updated dependencies from the X server.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/08/14/OpenType-Font-and-Font-Family/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/14/OpenType-Font-and-Font-Family/" class="post-title-link" itemprop="url">OpenType Font and Font Family</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 08-14-2021 13:31:56" itemprop="dateCreated datePublished" datetime="2021-08-14T13:31:56+12:00">08-14-2021</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 11-20-2021 14:20:58" itemprop="dateModified" datetime="2021-11-20T14:20:58+13:00">11-20-2021</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h3><p>Font family name (Name Id 1 in name table of the font) in a OpenType font file should not be used as the font-family property in CSS if the font is not one of regular, italic, bold, and bold italic style. Instead, the Typographic Family Name or Preferred Font Family (Name ID 16 in name table of the font) should be used if including them in CSS.</p>
<h3 id="Background-and-Problem"><a href="#Background-and-Problem" class="headerlink" title="Background and Problem"></a>Background and Problem</h3><p>Recently, I was tasked to investigate an interesting problem found in our custom font implementation. Font is something I have no prior knowledge about and this investigation really helped me learn a lot more about font and by writing it down, I hope I can help developers who may face similar problems.</p>
<p>Our system allows user to upload any font as long as they have the permission to use the font commercially. Recently, we realized that some of the fonts uploaded by user were not displayed correctly. More specifically the <code>font-family</code> attribute of these said fonts were incorrectly extracted.</p>
<p>As an example, an user uploaded a font called <code>fontA-SemiBold</code>, the extracted font-family name from the font was <code>fontA-SemiBold</code> whereas the correct name of for the font-family should be <code>fontA</code>. And in this case. The incorrect font name resulted in incorrect rendering in the front-end as the CSS rendering is suppose to have the correct font-family name.</p>
<h3 id="Investigation"><a href="#Investigation" class="headerlink" title="Investigation"></a>Investigation</h3><p>After looking at several of the uploaded fonts and going through the code, I decided it is necessary to create a small POC using the library we chose in our application. I was able to reproduce the issue that we face with the user uploaded font – the library yield an incorrect font-family name. This leads me to think whether the problem lies within the library itself. So I immediately used another font I found online. To my surprise, this time the library was able to extract the correct font-family.</p>
<p>Having done the POC, and finished this small experiment, I’m a bit at lost. <strong>How come the library sometimes work and sometimes failed to work?</strong></p>
<p><strong>Later, I realized this is because the font I chose happen to be <code>Roboto-Bold</code>.</strong></p>
<h3 id="Findings-and-learnings"><a href="#Findings-and-learnings" class="headerlink" title="Findings and learnings"></a>Findings and learnings</h3><p>To dig deeper into this, I went through the OpenType font specification on Microsoft website. The relevant part for the documentation is the <code>name</code> table for a font, so I read through all of it and here’s what I found and learnt: </p>
<ul>
<li>A font file contains a <em><strong>name</strong></em> table that stores the information about the font, this might include license for the font, font family name, urls etc. The library we used use this specific table to extract information about a font.</li>
<li>A font family name (name ID 1 in the name table) for a font can only be shared among at most four basic styles of font faces – they are regular, italic, bold, and bold italic. That is why the library returns the correct font family name for the <code>Roboto-Bold</code> I chose. </li>
<li>For styles that fall outside of these four styles, such as Semi-Bold or Black, they are treated as a separate font family and will have a separate font family name. For example, the font family name for <code>Roboto-Black</code> will be <code>Roboto-Black</code> rather than <code>Roboto</code>. </li>
<li>A Typographic Family Name (or Preferred Family) – Name Id 16 in the name table has no constraints in the number of font faces, but is only present when the font face falls outside of the basic four styles.</li>
<li>In CSS, the <code>font-family</code> property is expected to be the shared font name. For example, if using <code>Roboto-Black</code> font in CSS, the font-family property should be <code>Roboto</code> rather than <code>Roboto-Black</code></li>
<li>The difference between the font family name definition between CSS and the OpenType means that it is best to always use the <em><strong>Typographic Family Name</strong></em> if it presents rather than the <em><strong>Font Family name</strong></em> if the HTML/CSS is generated on the fly.</li>
</ul>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>As we have a better understanding on the font family specification now, we need to find ways to retrieve it from the font table. </p>
<p>Fontkit was the library of choice and therefore I will only discuss how to get the correct font family name in fontkit. Unfortunately, fontkit does not have a direct way of accessing the Typographic Family Name. Through reading its source code, I found the way to go is to use an undocumented API – <code>font.getName(&#39;preferredName&#39;)</code>, note that the <code>preferredName</code> is the same as Typographic Family Name, and it corresponds to name ID 16 in the font name table.</p>
<h3 id="Bonus-Using-fonttools-to-dump-and-inspect-font-tables"><a href="#Bonus-Using-fonttools-to-dump-and-inspect-font-tables" class="headerlink" title="Bonus: Using fonttools to dump and inspect font tables"></a>Bonus: Using fonttools to dump and inspect font tables</h3><p>Out of curiosity, and to verify Microsoft’s documentation I found a tool called fonttools which can be used to dump tables in a ttf/otf file to ttx format. This format is essentially an XML, you can open it with any text editor and inspect the content.</p>
<p>Installation of this tool can be done through pip: <code>pip install --user fonttools</code></p>
<p>Once installation’s finished, you can dump all the tables for a font file using <code>ttx &lt;fontfileName&gt;</code>. Note that this will result in an very large XML – roughly 120k lines. </p>
<p>As we are only interested in the name table, the following command can be used to dump that table only: <code>ttx -t name &lt;fontFileName&gt;</code></p>
<p>Here’s an example of the dump: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ttFont</span> <span class="attr">sfntVersion</span>=<span class="string">&quot;\x00\x01\x00\x00&quot;</span> <span class="attr">ttLibVersion</span>=<span class="string">&quot;4.26&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;0&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Copyright 2011 Google Inc. All Rights Reserved.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Roboto Black</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;2&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Regular</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Roboto Black</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;4&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Roboto Black</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;5&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Version 2.137; 2017</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;6&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Roboto-Black</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;7&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Roboto is a trademark of Google.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;9&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Google</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;11&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Google.com</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;12&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Christian Robertson</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;13&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Licensed under the Apache License, Version 2.0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;14&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;16&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Roboto</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">namerecord</span> <span class="attr">nameID</span>=<span class="string">&quot;17&quot;</span> <span class="attr">platformID</span>=<span class="string">&quot;3&quot;</span> <span class="attr">platEncID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">langID</span>=<span class="string">&quot;0x409&quot;</span>&gt;</span></span><br><span class="line">      Black</span><br><span class="line">    <span class="tag">&lt;/<span class="name">namerecord</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">ttFont</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="References-and-further-readings"><a href="#References-and-further-readings" class="headerlink" title="References and further readings"></a>References and further readings</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/typography/opentype/spec/name">https://docs.microsoft.com/en-us/typography/opentype/spec/name</a><br><a target="_blank" rel="noopener" href="https://github.com/foliojs/fontkit">https://github.com/foliojs/fontkit</a><br><a target="_blank" rel="noopener" href="https://github.com/fonttools/fonttools">https://github.com/fonttools/fonttools</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/07/10/Advanced-VirtualBox-Auto-start-virtualbox-on-Windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/10/Advanced-VirtualBox-Auto-start-virtualbox-on-Windows/" class="post-title-link" itemprop="url">Advanced VirtualBox: Auto start virtual machine on Windows</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 07-10-2021 12:18:14" itemprop="dateCreated datePublished" datetime="2021-07-10T12:18:14+12:00">07-10-2021</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 08-08-2021 16:00:15" itemprop="dateModified" datetime="2021-08-08T16:00:15+12:00">08-08-2021</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>I’ve always considered myself to be an advanced computer user, but I’m not a Windows person, at least not when I’m coding. So when I got a Windows 10 laptop as a daily work machine, I’m beyond disappointed. Luckily, there’s always a way around – VirtualBox it is. The laptop I got was powerful enough that I was able to allocate 16GB of memory as well as 3 cores of the host machine to the virtual machine.</p>
<p>Once I had my vm setup, I always use Windows Terminal and SSH into the machine for development. One day, it occurs to me I can (and should) automate all of this. </p>
<h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><p>Automatically start the selected VirtualBox virtual machine in <strong>headless</strong> mode (this can save a bit of resources), wait for the machine to boot, and then SSH into the VM using Windows Terminal with selected port forwarding on the host and virtual machine.</p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>This is not something that can be achieved in one go, therefore I’m going to breakdown by components: </p>
<ul>
<li>Virtual machine – Assuming Systemd based Linux distro<ul>
<li>We need to disable the graphical login interface for the VM. To achieve this, we can do <code>systemctl set-default multi-user.target </code>. If we need to revert back to graphical login, we can do <code>systemctl set-default graphical.target</code>. The multi-user.target and graphical.target are equivalent to what was traditionally known as run levels in SystemV.</li>
<li>We also need to setup the necessary SSH access from the Windows 10 host machine to the virtual machine. I won’t cover that here. Only thing to keep in mind is to open the necessary ports.</li>
</ul>
</li>
<li>Host machine – need to setup batch script, Windows Terminal profile and Window startup <ul>
<li>Batch script<ul>
<li>What we need to achieve in the batch script is start the machine and wait for it to boot. Fortunately, virtualbox installation comes with something that can achieve this, it is called VBoxmanage.exe and is in the VirtualBox installation folder</li>
<li>To start the virtual machine, the command will be <code>&quot;C:\Program Files\VirtualBox\VboxManage.exe&quot; startvm [VM name] --type headless</code>. Change the command with your VM name, the <code>--type headless</code> means that no GUI of the virtual machine will be started at all.</li>
<li>Next step is to wait for the machine to start up, the command for this will be <code>&quot;C:\Program Files\VirtualBox\VboxManage.exe&quot; wait &quot;[VM name]&quot; &quot;/VirtualBox/GuestInfo/OS/NoLoggedInUsers&quot;</code></li>
<li>Last step for the batch script will be <code>wt</code>, which represents windows terminal.</li>
<li>To put it together, the batch script will be <figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">&quot;C:\Program Files\VirtualBox\VboxManage.exe&quot; startvm [VM name] --<span class="built_in">type</span> headless</span><br><span class="line">&quot;C:\Program Files\VirtualBox\VboxManage.exe&quot; wait &quot;[VM name]&quot; &quot;/VirtualBox/GuestInfo/OS/NoLoggedInUsers&quot;</span><br><span class="line">wt</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Windows terminal profile<ul>
<li>Create a profile in Windows terminal, this can be done from either the UI or the json setting file.</li>
<li>Here, I will present the profile I use personally: <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;bellStyle&quot;</span>: <span class="string">&quot;visual&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;colorScheme&quot;</span>: <span class="string">&quot;Tango Dark&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;commandline&quot;</span>: <span class="string">&quot;ssh -R 5432:localhost:5432 -L 8080:[::1]:8080 -L 3000:[::1]:3000 -t username@vm_ip_address &quot;</span>exec zsh -l<span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;VM&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;scrollbarState&quot;</span>: <span class="string">&quot;hidden&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>It is obvious the commandline part is a bit bloated cause I was trying to do a bit too much in one go. Actually, it is a lot cleaner to put the command in a batch file and this line can be replaced by the path to that specific batch file as well.</li>
</ul>
</li>
<li>Windows Auto Start<ul>
<li>Press Windows+R and type <code>shell:startup</code>, this will bring up a folder called “StartUp” where you can put a bunch of things that you want to auto start when Windows starts.</li>
<li>Drag the Batch script created into this folder to create a shortcut.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>After these setup, Windows will now start the virtual machine every time you start your computer.</p>
<h3 id="Bonus-shutdown-VM-in-one-click"><a href="#Bonus-shutdown-VM-in-one-click" class="headerlink" title="Bonus: shutdown VM in one click"></a>Bonus: shutdown VM in one click</h3><p>The same aforementioned VboxManage.exe can be used to poweroff the virtual machine as well. You can achieve that by creating a batch file with the following content: </p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">&quot;C:\Program Files\Oracle\VirtualBox\VBoxManage.exe&quot; controlvm DEV_MACHINE poweroff</span><br></pre></td></tr></table></figure>

<p>You can also halt or save the state of the VM rather than poweroff. More information on this can be found in the virtualbox manual.</p>
<h3 id="Further-readings"><a href="#Further-readings" class="headerlink" title="Further readings"></a>Further readings</h3><p><a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch08.html">VirualBox manual on VboxManage</a><br><a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/systemd.special.html">Systemd manual on special units</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/06/30/IELTS-exam-and-experience/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/30/IELTS-exam-and-experience/" class="post-title-link" itemprop="url">IELTS exam and experience</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 06-30-2021 21:13:50" itemprop="dateCreated datePublished" datetime="2021-06-30T21:13:50+12:00">06-30-2021</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 07-10-2021 12:15:14" itemprop="dateModified" datetime="2021-07-10T12:15:14+12:00">07-10-2021</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Though this is technically a tech blog where I usually put my thoughts and learnings regarding technologies, I still would like to share some of my experience with taking the IELTS exam which is about a month ago. </p>
<p><strong>Please note that the author is in no way affiliate with the websites and/or services mentioned below, use of these software and/or services is at the sole discretion of the reader</strong></p>
<h3 id="Why-I-choose-to-take-IELTS"><a href="#Why-I-choose-to-take-IELTS" class="headerlink" title="Why I choose to take IELTS"></a>Why I choose to take IELTS</h3><p>To be honest, my current status does not require me to take the IELTS exam. Though after some consideration, I have decided to take the exam and see if I can benefit from extra immigration points by taking the IELTS exam. My goal is reaching 8 in listening and 7 in all other sections. I made the decision to take the exam on the night of May 22nd, 2021. I took the exam on June 13th, 2021. The preparation time is around 21 days.</p>
<h3 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h3><p>I have a day job, so my preparation time on working days was quite limited. I usually get home at around 6pm. My dinner and routine exercise finishes at 8pm. So my preparation for IELTS starts at 8:15pm to 8:30pm. </p>
<p>The list of tools and/or books I used are listed below: </p>
<ul>
<li><p>Road to IELTS<br>  This is an comprehensive tool that can be used to prepare for both the academic and the general training version of the exam. It was offered for free at my local public library. I’m very greatful to my local library for offering such an invaluable service, it helped me quite a lot.<br>  As for using this tool, different people may have different ideas. I used this mainly as a training tool to familiarize myself with the listening and reading part on computer-based IELTS exam. In this system, there are 10 mock exams for each part of the IELTS exam which is what I used most for listening and reading. I alternate between Reading and Listening on each working day, spending around 1 to 1.5 hours on this.<br>  There are mini practice sections for each parts as well, this was mainly to educate test takers on different kind of formats for the listening and speaking test. As this is not my first time taking the IELTS exam, I skip most of them. But I can see how they are helpful for those who are taking IELTS for the first time.<br>  The difficulty level on the mock exams are actually a bit higher than the actual exam, it could be because the mocked test delivery system is not smart enough and misses out correct answer sometimes. As a reference, I usually get around 33 correct in the Listening section, which translates to about 6.5. I got 9 in the actual IELTS exam for the listening. For the reading part, I usually get around 32 correct which is also 6.5, while in my actual IELTS test, I got 8.5.<br>  For writing and speaking, it is also practical to use the mocked exams, the only caveate is that no one will grade thsoe. I would suggest at least read through the sample exam essays provided, and try to follow the structure and learn some good words from the essay. For speaking, I don’t feel like you can improve your speaking skills in a short time, but the mock exams offered is still helpful.</p>
</li>
<li><p>Writing 9<br>  This is a paid service that’s offered at 12 USD per month. I found it quite helpful, cause you can actually mock a writing exam with it. I did around 3 to 4 essays on it and get around 6.5 each. The thing I like about this tool is that it can spot your spelling mistakes among other things.</p>
</li>
<li><p>Simon’s writing course<br>  This is one of the courses that I definitely recommend watching. This course had helped me a lot in achieving the score of 7 on writing. To summarize on what I had learnt from this course: IELTS writing is not only about good use of words, but also about organizing the structure of the essay logically. I do think the latter what I used to ignore. In my first IELTS exam taken at 2011 (at that time, I took the Acacdemic version) I only got 5.5 in IELTS writing, and 10 years later, I got 7 for the general training version.</p>
</li>
<li><p>IELTS Band 9 Vocab Secrets by Caambridge Consultants<br>  This book contains loads of good examples about usage of good words in either reading and writing. I highly recommend reading through the whole book at least once and practice using the word examples given in the book.</p>
</li>
</ul>
<h3 id="Exam-tips"><a href="#Exam-tips" class="headerlink" title="Exam tips"></a>Exam tips</h3><p>For me, this is my first time taking the computer-based IELTS exam. I would like to share some tips that I think other candidates may find useful: </p>
<ul>
<li>Listening<ul>
<li>From my experience on taking both the mocked and the actual exam, Computer-based listening test is a bit more difficult than paper-based ones. There are several reasons for this: <ul>
<li>In computer based exam, you will not be given time to transfer your answers from the exam paper to the answer sheet. Instead, you will only be given 2 minutes to check for all the answers at the end of the listening test. This means that you may not have enough time to check for some easily identifiable mistakes like typos, singular/plural forms or tense problems. So when you practice, keep this in mind, and try to avoid them as much as possible.</li>
<li>You will have to type and listen and the same time in computer based exam. I guess this is quite obvious, it might not be a big problem but keep in mind that in the IELTS exam, you are under considerable stress, for non-native speakers, it may be a bit difficult.</li>
</ul>
</li>
<li>Highlighting is important in listening test. For me, this is how I achieved Band 9 in listening – I highlight things I think are important. In computer based exams, highlighting will help you focus on the keywords and in my experience, I feel more confident when I highlight things.</li>
</ul>
</li>
<li>Reading: <ul>
<li>Highlighting, again. Highlighting is also important in reading. I’m glad that the testing system provides a way to highlight in reading, it is really helpful and mimics the paper exam well.</li>
<li>Try to use the color settings to avoid eye strain. The computer delivered IELTS exam have settings to change the background color of the exam. To me, this is really helpful. I changed the background color from white to a bit more yellowish. This causes less eye strain and helped me focus on the exam better.</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/05/09/Postgres-JavaScript-and-sorting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/09/Postgres-JavaScript-and-sorting/" class="post-title-link" itemprop="url">Postgres, JavaScript and sorting</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 05-09-2021 13:00:12 / Modified: 13:07:18" itemprop="dateCreated datePublished" datetime="2021-05-09T13:00:12+12:00">05-09-2021</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This week, while setting up local project for work, I encountered some weired issue during the unit test and this has something to do with postgres and its default settings under Windows and other OS.</p>
<h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><p>As an example, consider the following array: <code>[ &#39;D&#39;, &#39;d&#39;, &#39;a&#39;, &#39;A&#39;, &#39;c&#39;, &#39;b&#39;, &#39;CD&#39;, &#39;Capacitor&#39; ]</code></p>
<p>Sorting this in JavaScript results in case sensitive result, where upper case always come first: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [ <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;CD&#x27;</span>, <span class="string">&#x27;Capacitor&#x27;</span> ].sort()</span><br><span class="line">[ <span class="string">&quot;A&quot;</span>, <span class="string">&quot;CD&quot;</span>, <span class="string">&quot;Capacitor&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span> ]</span><br></pre></td></tr></table></figure>
<p>Sorting this in Postgres SQL with default installation will yield a case insensitive sorting where upper and lower case are mixed:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> regexp_split_to_table(<span class="string">&#x27;D d a A c b CD Capacitor&#x27;</span>, <span class="string">&#x27; &#x27;</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"> regexp_split_to_table </span><br><span class="line"><span class="comment">-----------------------</span></span><br><span class="line"> a</span><br><span class="line"> A</span><br><span class="line"> b</span><br><span class="line"> c</span><br><span class="line"> Capacitor</span><br><span class="line"> CD</span><br><span class="line"> d</span><br><span class="line"> D</span><br></pre></td></tr></table></figure>

<p>The goal here is to make sorting consistent, so we can either fix the Postgres side or fix the JavaScript side.</p>
<h3 id="Investigation"><a href="#Investigation" class="headerlink" title="Investigation"></a>Investigation</h3><p>Looking carefully at each of these results, it is not difficult to realize that the sorting in JavaScript is based on ASCII, i.e. character <code>A</code> has an ASCII code of 32 where as <code>a</code> has ASCII code of 97, so <code>A</code> comes first. This <strong>IS NOT</strong> the proper way to do string sorting in JavaScript.</p>
<p>For the result that Postgres gave, it is a bit more complex. Postgres uses <code>LC_COLLATE</code> to determine the sort order of the array.This variable comes from the system and different OS have different implementation, when using locale <code>C</code> or <code>POSIX</code>, strings are sorted according to their ASCII value, any other locales will result in a case insensitive result.</p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>Here comes the solution part, as mentioned earlier, we can either fix the JavaScript or fix the Postgres, so I’ll present the solutions separately.</p>
<p>There are several ways to make the sorting case insensitive in JavaScript: </p>
<ul>
<li><p><code>[ &#39;D&#39;, &#39;d&#39;, &#39;a&#39;, &#39;A&#39;, &#39;c&#39;, &#39;b&#39;, &#39;CD&#39;, &#39;Capacitor&#39; ].sort((a,b) =&gt; a.localeCompare(b))</code><br>This uses localeCompare from string prototype which have some performance implication on larger array.</p>
</li>
<li><p><code>[ &#39;D&#39;, &#39;d&#39;, &#39;a&#39;, &#39;A&#39;, &#39;c&#39;, &#39;b&#39;, &#39;CD&#39;, &#39;Capacitor&#39; ].sort(new Intl.Collator(&#39;en_us&#39;).compare)</code><br>This is the recommended by MDN to sort larger arrays.</p>
</li>
</ul>
<p>For Postgres, the first thing that needs to be noted is that Postgres recommends against using locales if it can be avoided, from their documentation: </p>
<blockquote>
<p>The drawback of using locales other than C or POSIX in PostgreSQL is its performance impact. It slows character handling and prevents ordinary indexes from being used by LIKE. For this reason use locales only if you actually need them. </p>
</blockquote>
<p>The one-off way to fix the sorting is by specifiying the <code>LC_COLLATE</code> value when creating the database, for example: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE db </span><br><span class="line">    <span class="keyword">WITH</span> TEMPLATE <span class="operator">=</span> template0 </span><br><span class="line">    ENCODING <span class="operator">=</span> <span class="string">&#x27;UTF8&#x27;</span> </span><br><span class="line">    LC_COLLATE <span class="operator">=</span> <span class="string">&#x27;C&#x27;</span> </span><br><span class="line">    LC_CTYPE <span class="operator">=</span> <span class="string">&#x27;C&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>The created database (db in this case) will use <code>C</code> as <code>LC_COLLATE</code> overriding the default <code>LC_COLLATE</code> value from the OS. With the new database created, you easily verify it will sort in a case sensitive way by the ASCII value once you connect to the database and run the query presented previously.</p>
<p>This one-off way is good enough only if you care about creating such database once. Imaging next time you create a new database, you will still have to manually override the <code>LC_COLLATE</code> value. So the way to go is to modify the template database, because <code>LC_COLLATE</code> can’t be changed once the database has been created, we will have to create a new database and set it as template. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--- Unset template1 as template before dropping</span></span><br><span class="line">UPDATE pg_database </span><br><span class="line">    <span class="keyword">SET</span> datistemplate<span class="operator">=</span><span class="string">&#x27;false&#x27;</span> </span><br><span class="line">    <span class="keyword">WHERE</span> datname<span class="operator">=</span><span class="string">&#x27;template1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--- Create a new database that uses C as locale</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE template1 </span><br><span class="line">    IS_TEMPLATE <span class="literal">true</span> </span><br><span class="line">    ENCODING <span class="operator">=</span> <span class="string">&#x27;UTF8&#x27;</span> </span><br><span class="line">    LC_COLLATE <span class="operator">=</span> <span class="string">&#x27;C&#x27;</span> </span><br><span class="line">    LC_CTYPE <span class="operator">=</span> <span class="string">&#x27;C&#x27;</span> </span><br><span class="line">    CONNECTION LIMIT <span class="operator">=</span> <span class="number">-1</span> </span><br><span class="line">    TEMPLATE template0;</span><br><span class="line"></span><br><span class="line"><span class="comment">--- Create a new databse now should have C as locale.</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db3;</span><br><span class="line"></span><br><span class="line"><span class="comment">--- Should return C </span></span><br><span class="line"><span class="keyword">SHOW</span> lc_collate;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Another way to do this, is to initialize the database cluster with C locale as below: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R postgres:postgres /var/lib/postgres/</span><br><span class="line">su - postgres -c &quot;initdb --locale C -D &#x27;/var/lib/postgres/data&#x27;&quot;</span><br></pre></td></tr></table></figure>
<p>this will create template database with C locale.</p>
<h3 id="Takeaways"><a href="#Takeaways" class="headerlink" title="Takeaways"></a>Takeaways</h3><p>String sorting with the default method in JavaScript and most other languages is merely a comparsion based on the ASCII code, this results in upper case letters always comes first.</p>
<p>String sorting in PostgreSQL depends on the <code>LC_COLLATE</code> setting of the table which depends on the setting of the operating system, default sorting will yield results that mixes upper case and lower case, in other words, sorting is <strong>not</strong> case sensitive. There are many ways to get case sensitive sorting, but the most reliable way should be specifiying the <code>LC_COLLATE</code> when creating the database.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/13/locale.html">https://www.postgresql.org/docs/13/locale.html</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare</a></li>
<li><a target="_blank" rel="noopener" href="https://dba.stackexchange.com/questions/106964/why-is-my-postgresql-order-by-case-insensitive">Stackexchange question</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.postgresql.org/wiki/FAQ#Why_do_my_strings_sort_incorrectly.3F">Postgres FAQ</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/04/17/Android-ADB-and-user-management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/17/Android-ADB-and-user-management/" class="post-title-link" itemprop="url">Android ADB and user management</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 04-17-2021 16:24:17 / Modified: 17:26:25" itemprop="dateCreated datePublished" datetime="2021-04-17T16:24:17+12:00">04-17-2021</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>⚠ This article requires Rooted Android phones, please follow the instructions with caution.</p>
<h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>Since Android 5, the Android system have added the capability of multi-user, the aim is most likely to make sharing devices easier between different users in the family. Later on, Google added again something called profile, this allows enterprise to manage devices their employers use. In this article, I am going to explore some other possibilities enabled by multiuser/profile functionality. More specifically I’m going to focus on the restricted user profile. </p>
<h3 id="Problem-to-Solve"><a href="#Problem-to-Solve" class="headerlink" title="Problem to Solve"></a>Problem to Solve</h3><p>There are several problems I’m aiming to solve with the restricted profile: </p>
<ul>
<li>I want to focus on things that actually matter rather than spending too much time on my phone, I would like my phone to be without any apps that can disturb or distract me when I want to focus. But I don’t want to uninstall certain apps, as they are necessary in order to keep in touch with my family and friends.</li>
<li>I want to install certain apps that can track me into a separate space, a space where it is impossible for them to track me using the microphone, camera, or location.</li>
</ul>
<h3 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h3><p>Well, as an Android user that also owns an iOS device, I have to say Apple have done a good job in many of the things I mentioned above. For example, my first problem can be solved in the iOS setting natively. Android does have something similar called digital wellbeing, but since it is from Google, I’m not that comfortable installing it on to my phone. </p>
<p>Anyway, I feel like the restricted profile is still a good solution to my problem on Android.</p>
<h3 id="How-to"><a href="#How-to" class="headerlink" title="How to?"></a>How to?</h3><p>So in Android shell, there’s something called pm. This command can be used to create a new user.<br>Here is part of the help doc that I’m interested in:</p>
<p><code>create-user [--profileOf USER_ID] [--managed] [--restricted] [--ephemeral] [--guest] USER_NAME         Create a new user with the given USER_NAME, printing the new user identifier of the user.</code></p>
<p>That is, command <code>pm create-user</code> can be used to create user on your Android phone. Assuming you have access to Android adb, issuing<br><code>adb shell pm create-user --restricted test</code> will create a user named test with restricted profile, the command will show the userid of the newly created user, will be referenced as <code>$userId</code> in the following.</p>
<p>Once the user has been created, you can manage the list of the users it will have access to in the settings, this is in Settings/Multi-user. </p>
<p>To me, I want impose more restrictions on the user, there is indeed a way to do so:</p>
<p><code>adb shell su -c &#39;pm set-user-restriction --user USER_ID no_install_apps 1&#39;</code> – this will disallow install apps for the newly created profile, in this case <strong>no_install_apps</strong> is the name of the restriction, while the ** 1** immidiately follow is a boolean representing whether the restriction is enabled. (This command assumes you use Magsik as su)</p>
<p>You can find a list of restrictions available from Google’s official <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/os/UserManager#constants_1">document</a>. Take note of the <code>Constant Value</code> in the document, that’s the restriction value you need to use.</p>
<p>If you want to see what restriction you’ve added, you can issue <code>adb shell dumpsys user</code>, this command will dump all the users on the current device and the restrictions if any.</p>
<p>To switch to a different user, you can use <code>am switch-user USER_ID</code> or do so from the UI.</p>
<p>The easiest way to delete an user is through the settings menu. Though you can also do so through the command: <code>pm remove-user USER_ID</code></p>
<h3 id="Caveat"><a href="#Caveat" class="headerlink" title="Caveat"></a>Caveat</h3><p>There are several issues that need to be taken into consideration when using a restricted profile: </p>
<ol>
<li>You will not have access to any of the files in the primary account, this is a big issue if you have social media apps installed on this account and want to upload image from the primary account.</li>
<li>You will not have Google account access or root access. Most people will be okay with this, but it is a bit troublesome at times.</li>
<li>Remember to switch the profile back, when you no longer need to be in the restricted one. For example, if you leave your restricted profile on overnight, you will not have an alarm clock if you don’t set it up correctly.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/02/27/Terraform-version-constraint-and-debugging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/27/Terraform-version-constraint-and-debugging/" class="post-title-link" itemprop="url">Terraform, Version Constraint and Debugging</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 02-28-2021 10:08:59 / Modified: 13:03:30" itemprop="dateCreated datePublished" datetime="2021-02-28T10:08:59+13:00">02-28-2021</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This week I encountered some issues with Terraform (and, well, Kubernetes) again. This time, the problem was way more interesting than I thought.</p>
<h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><p>When deploying to Kubernetes, I got <code>dial tcp 127.0.0.1:80: connect: connection refused, connection reset error.</code></p>
<p>The more specific error message I got is </p>
<blockquote>
<p>Error: Get “<a target="_blank" rel="noopener" href="http://localhost/apis/apps/v1/namespaces/default/deployments/xxx&quot;">http://localhost/apis/apps/v1/namespaces/default/deployments/xxx&quot;</a>: dial tcp 127.0.0.1:80: connect: connection refused</p>
</blockquote>
<p>As this error happened in our deployment pipeline (we use Terraform to deploy stuff to Kubernetes), my natural thought was that this can be solved easily with a retry. So I retried the deployment right away, and it still failed. </p>
<p>When I finally stopped what I was working on and start to examine the message carefully, I realized it is quite strange: how come the pipeline (or the Kubectl for that matter) trying to connect to localhost when it is meant to connect to a Kubernetes cluster located somewhere else? </p>
<p>As you will see from my solution, this message was <strong>not</strong> helpful at all and in some sense quite misleading to someone who is trying to debug.</p>
<p>After comparing the log from a previous successful deployment and the said failed deployment. I realized the issue was with the Kubernetes provider for Terraform: while in the successful build, the <code>terraform init</code> command yield something like <code>Installing hashicorp/kubernetes v1.13.3...</code>, in the failed build the same command yield something like <code>Installing hashicorp/kubernetes v2.0.2...</code>. </p>
<p>It is quite obvious that this issue was caused by breaking changes in the Terraform provider. According to their <a target="_blank" rel="noopener" href="https://github.com/hashicorp/terraform-provider-kubernetes/blob/master/CHANGELOG.md#200-january-21-2021">changelog</a>, there were several breaking changes in the 2.0.0 version, among them were these two:</p>
<blockquote>
<p>Remove load_config_file attribute from provider block (#1052)<br>Remove default of ~/.kube/config for config_path (#1052)</p>
</blockquote>
<p>In our deployment Terraform, we set <code>load_config_file</code> to <code>true</code> to load the <code>kube_config</code> file from the default config_path of <code>~/.kube/config</code>. Due to the breaking changes quoted above, neither the <code>load_config_file</code> nor the default config_path existed any more, and when Kubernetes can not find these two files, it will try to connect to the 127.0.0.1 (aka localhost) as a fallback which caused the connection refused error.</p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>There are two kind of solutions to this issue: </p>
<ul>
<li>Updating the Terraform code so it is compatible with the 2.0.0 version of the Kubernetes provider<br>OR</li>
<li>Downgrade to the last working version of the Kubernetes provider and keep the existing Terraform code</li>
</ul>
<p>Due to the urgency of getting the pipeline and deployment back online, I chose the downgrading route. Essentially, I’m adding the version constraint to the Kubernetes provider that was previously missing:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubernetes &#x3D; &#123;</span><br><span class="line">  source  &#x3D; &quot;registry.terraform.io&#x2F;hashicorp&#x2F;kubernetes&quot;</span><br><span class="line">  version &#x3D; &quot;~&gt; 1.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Adding in the version constraint means that Terraform will only increase the <em><strong>rightmost</strong></em> version number, therefore it will not be able to upgrade to version 2.0.0 automatically and can avoid this specific problem that was caused by breaking changes.</p>
<h3 id="Takeaways"><a href="#Takeaways" class="headerlink" title="Takeaways"></a>Takeaways</h3><p>On debugging:</p>
<ul>
<li>Generally speaking, if you found your Terraform changed behavior without you making any changes, you could be making the same mistake as I did: not specifying the version constraint for the provider. You can find some clues in your <code>terraform init</code> command, for example, by comparing if the same provider version was used on the two builds where one was successful, the other failed.</li>
<li>Personally, I was never familiar enough with Kubernetes to know that the default behavior of Kubectl is to use 127.0.0.1 when there’s no config file present. Now that I came across this gotcha, I do realize this kind of behavior was not that uncommon per se: Knex which is the library we used for node.js also have similar behavior, and I will keep this in mind if I encounter something similar in the future.</li>
</ul>
<p>On Terraform:</p>
<ul>
<li>When there’s no version constraint specified, Terraform will always use the latest provider version. Therefore, it is important to specify the version constraint. It is recommended by Terraform to always use a specific version when using third party modules. For more information on specifying the version constraint, read the <a target="_blank" rel="noopener" href="https://www.terraform.io/docs/language/expressions/version-constraints.html">documentation</a> from their website.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-Hans,default">
    <link itemprop="mainEntityOfPage" href="http://kevinsj.github.io/2021/01/24/Lessons-Learnt-On-Deploying-GO-Lambda-Application-on-AWS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="KevinSJ">
      <meta itemprop="description" content="A blog about all things tech.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Jiang's Technical Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/24/Lessons-Learnt-On-Deploying-GO-Lambda-Application-on-AWS/" class="post-title-link" itemprop="url">Lessons Learnt On Deploying GO Lambda Application on AWS - Part I</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 01-24-2021 19:06:00" itemprop="dateCreated datePublished" datetime="2021-01-24T19:06:00+13:00">01-24-2021</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 01-30-2021 10:43:09" itemprop="dateModified" datetime="2021-01-30T10:43:09+13:00">01-30-2021</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Recently, I started to build an application with Go, it is a quite simple application that does something very basic and then sends an notification to a telegram bot. It’s quite obvious to me this kind of application is quite suitable to run as Lambda, and that’s where I decided to deploy my application to once it is working well locally. It turned out that I had to solve several issues I encountered. Here I share how I solved those issues, so you don’t have to scratch your head when encounter them.</p>
<h3 id="Attempt-1-Deploy-the-application-through-the-web-interface"><a href="#Attempt-1-Deploy-the-application-through-the-web-interface" class="headerlink" title="Attempt 1: Deploy the application through the web interface."></a>Attempt 1: Deploy the application through the web interface.</h3><p>For my first attempt on deploying the application, my goal is to make things as simple as possible.<br>Therefore, I chose to use the web interface. From the web interface, there’s an option to upload zip file and that’s where I began.</p>
<h5 id="Problem-Compile-GO-in-an-static-way"><a href="#Problem-Compile-GO-in-an-static-way" class="headerlink" title="Problem: Compile GO in an static way"></a>Problem: Compile GO in an static way</h5><p>This problem happens quite often from what I see on the internet. The main issue with here is that, some of the libraries in GO uses a feature called <a target="_blank" rel="noopener" href="https://golang.org/cmd/cgo/">CGO</a> which means using C code in GO, and when this feature is in use, GO compiler will try to create dynamic binary.</p>
<p>To solve this problem, it is often as simple as compiled the code to a statically linked binary. Do note that, some of the code that’s compiling use GCC was not working, this is because often times the GLIBC library is higher than the ones used in AWS lambda environment, at least that was the case for me (I am on an Linux laptop with Manjaro Linux).</p>
<p>I was able to find something called <a target="_blank" rel="noopener" href="https://www.musl-libc.org/intro.html">musl-gcc</a> and then used it in my compilation </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">build:</span></span><br><span class="line">	CC=<span class="string">&quot;musl-gcc&quot;</span> go build --ldflags &#x27;-linkmode external -extldflags <span class="string">&quot;-static&quot;</span>&#x27; ./main.go</span><br></pre></td></tr></table></figure>
<p>This proves to be working fine, once I complied the binary, zip and upload it to lambda through the interface, everything seems to be working.</p>
<h3 id="Attempt-2-Deploy-the-application-through-AWS-SAM"><a href="#Attempt-2-Deploy-the-application-through-AWS-SAM" class="headerlink" title="Attempt 2: Deploy the application through AWS SAM"></a>Attempt 2: Deploy the application through AWS SAM</h3><p>Often, it is not efficient to manually upload the code using a zip file through every time, that’s why I started to thinking about introducing <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html">SAM</a> as a tool to simplified the process of deployment. This was when I encountered the second issue.</p>
<h4 id="Problem-Asking-SAM-to-compile-the-GO-program-in-an-static-way"><a href="#Problem-Asking-SAM-to-compile-the-GO-program-in-an-static-way" class="headerlink" title="Problem: Asking SAM to compile the GO program in an static way."></a>Problem: Asking SAM to compile the GO program in an static way.</h4><p>As the line above says, SAM always compiled the code in a dynamic way which is why the binary fails to work again even locally using the command <code>sam invoke local</code>.</p>
<p>Now it’s the time to tell SAM I don’t want dynamically linked binaries. As a matter of fact, none of the article available online has a direct answer to my question, fortunately, I did find an AWS documentation on <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/building-custom-runtimes.html">using custom runtime</a>. Based on this article, a GO program that wants to utilize static linking can have the following template:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">HelloGOFunction:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Serverless::Function</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">FunctionName:</span> <span class="string">HelloGO</span></span><br><span class="line">      <span class="attr">Handler:</span> <span class="string">main</span></span><br><span class="line">      <span class="attr">Runtime:</span> <span class="string">go1.x</span></span><br><span class="line">      <span class="attr">MemorySize:</span> <span class="number">512</span></span><br><span class="line">      <span class="attr">CodeUri:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">Metadata:</span></span><br><span class="line">      <span class="attr">BuildMethod:</span> <span class="string">makefile</span></span><br></pre></td></tr></table></figure>
<p>And in the MakeFile, the following corresponding entries need to be added:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">build-HelloGOFunction:</span></span><br><span class="line">  CC=<span class="string">&quot;musl-gcc&quot;</span> go build --ldflags &#x27;-linkmode external -extldflags <span class="string">&quot;-static&quot;</span>&#x27; ./main.go</span><br><span class="line">  cp ./main <span class="variable">$(ARTIFACTS_DIR)</span></span><br></pre></td></tr></table></figure>
<p>Doing so will make sure compiled binary are statically linked and works on lambda when bundle and uploaded.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">KevinSJ</p>
  <div class="site-description" itemprop="description">A blog about all things tech.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kevinsj" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kevinsj" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/kevsj" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;kevsj" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KevinSJ</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="https://unpkg.com/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body>
</html>
