import{b7 as d}from"./index-0c1fde36.js";import{Y as m}from"./index-84e3bf78.js";import{c as g}from"./composerize-4a5589d8.js";class h{constructor(){this.image="",this.containerName=null,this.exec=null,this.addCapability=[],this.dropCapability=[],this.addDevice=[],this.mount=[],this.volume=[],this.network=[],this.networkAlias=[],this.publishPort=[],this.exposeHostPort=[],this.ip=null,this.ip6=null,this.dns=[],this.dnsOption=[],this.dnsSearch=[],this.environment=[],this.environmentFile=[],this.environmentHost=!1,this.noNewPrivileges=!1,this.securityLabelDisable=!1,this.securityLabelFileType=null,this.securityLabelLevel=null,this.securityLabelNested=!1,this.securityLabelType=null,this.seccompProfile=null,this.mask=[],this.unmask=null,this.user=null,this.group=null,this.groupAdd=[],this.userNS=null,this.uidMap=[],this.gidMap=[],this.subUidMap=null,this.subGidMap=null,this.readOnly=!1,this.readOnlyTmpfs=!0,this.runInit=!1,this.workingDir=null,this.hostName=null,this.timezone=null,this.shmSize=null,this.tmpfs=[],this.healthCmd=null,this.healthInterval=null,this.healthOnFailure=null,this.healthRetries=null,this.healthStartPeriod=null,this.healthStartupCmd=null,this.healthStartupInterval=null,this.healthStartupRetries=null,this.healthStartupSuccess=null,this.healthStartupTimeout=null,this.healthTimeout=null,this.notify="conmon",this.stopSignal=null,this.stopTimeout=null,this.pod=null,this.logDriver=null,this.logOpt=[],this.label=[],this.annotation=[],this.pidsLimit=null,this.ulimit=[],this.sysctl=[],this.autoUpdate=null,this.pull=null,this.secret=[],this.rootfs=null,this.entrypoint=null,this.podmanArgs=null}setImage(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Image must be a non-empty string");return this.image=t.trim(),this}setContainerName(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Container name must be a non-empty string");const e=/^[a-zA-Z0-9][a-zA-Z0-9_.-]*$/,i=t.trim();if(!e.test(i))throw new Error("Container name must start with alphanumeric character and contain only alphanumeric characters, underscores, periods, and hyphens");return this.containerName=i,this}setExec(t){if(t&&typeof t!="string")throw new Error("Exec command must be a string");return this.exec=t,this}addPublishPort(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Port must be a non-empty string");const e=t.trim();if(!/^(\d+:)?\d+(\/(?:tcp|udp|sctp))?$/.test(e))throw new Error('Port must be in format "host:container" or "container", optionally with protocol "/tcp", "/udp", or "/sctp"');const r=e.replace(/\/(?:tcp|udp|sctp)$/,"").split(":");for(const a of r){const o=parseInt(a,10);if(o<1||o>65535)throw new Error(`Port ${o} is out of valid range (1-65535)`)}return this.publishPort.push(e),this}addEnvironment(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Environment variable must be a non-empty string");const e=t.trim();if(!e.includes("="))throw new Error('Environment variable must be in format "KEY=value"');return this.environment.push(e),this}addVolume(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Volume must be a non-empty string");const e=t.trim();if(!e.includes(":")&&!e.startsWith("/"))throw new Error('Volume must be in format "source:destination" or an absolute path');return this.volume.push(e),this}addLabel(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Label must be a non-empty string");const e=t.trim();if(!e.includes("="))throw new Error('Label must be in format "key=value"');return this.label.push(e),this}setPod(t){return this.pod=t,this}getDefaultName(){if(this.containerName)return this.containerName;const t=this.image.split("/");return t[t.length-1].split(":")[0]}validate(){if(!this.image)throw new Error("Image is required");for(const t of this.publishPort)try{const e=t.split(":");for(const i of e){const s=parseInt(i,10);if(isNaN(s)||s<1||s>65535)throw new Error(`Invalid port: ${t}`)}}catch(e){throw e.message.startsWith("Invalid port:")?e:new Error(`Invalid port format: ${t}`)}}clone(){const t=new h;return t.image=this.image,t.containerName=this.containerName,t.exec=this.exec,t.ip=this.ip,t.ip6=this.ip6,t.environmentHost=this.environmentHost,t.noNewPrivileges=this.noNewPrivileges,t.securityLabelDisable=this.securityLabelDisable,t.securityLabelFileType=this.securityLabelFileType,t.securityLabelLevel=this.securityLabelLevel,t.securityLabelNested=this.securityLabelNested,t.securityLabelType=this.securityLabelType,t.seccompProfile=this.seccompProfile,t.unmask=this.unmask,t.user=this.user,t.group=this.group,t.userNS=this.userNS,t.subUidMap=this.subUidMap,t.subGidMap=this.subGidMap,t.readOnly=this.readOnly,t.readOnlyTmpfs=this.readOnlyTmpfs,t.runInit=this.runInit,t.workingDir=this.workingDir,t.hostName=this.hostName,t.timezone=this.timezone,t.shmSize=this.shmSize,t.healthCmd=this.healthCmd,t.healthInterval=this.healthInterval,t.healthOnFailure=this.healthOnFailure,t.healthRetries=this.healthRetries,t.healthStartPeriod=this.healthStartPeriod,t.healthTimeout=this.healthTimeout,t.healthStartupCmd=this.healthStartupCmd,t.healthStartupInterval=this.healthStartupInterval,t.healthStartupRetries=this.healthStartupRetries,t.healthStartupSuccess=this.healthStartupSuccess,t.healthStartupTimeout=this.healthStartupTimeout,t.notify=this.notify,t.stopSignal=this.stopSignal,t.stopTimeout=this.stopTimeout,t.pod=this.pod,t.logDriver=this.logDriver,t.pidsLimit=this.pidsLimit,t.autoUpdate=this.autoUpdate,t.pull=this.pull,t.rootfs=this.rootfs,t.entrypoint=this.entrypoint,t.podmanArgs=this.podmanArgs,t.addCapability=[...this.addCapability],t.dropCapability=[...this.dropCapability],t.addDevice=[...this.addDevice],t.mount=[...this.mount],t.volume=[...this.volume],t.network=[...this.network],t.networkAlias=[...this.networkAlias],t.publishPort=[...this.publishPort],t.exposeHostPort=[...this.exposeHostPort],t.dns=[...this.dns],t.dnsOption=[...this.dnsOption],t.dnsSearch=[...this.dnsSearch],t.environment=[...this.environment],t.environmentFile=[...this.environmentFile],t.mask=[...this.mask],t.groupAdd=[...this.groupAdd],t.uidMap=[...this.uidMap],t.gidMap=[...this.gidMap],t.tmpfs=[...this.tmpfs],t.label=[...this.label],t.logOpt=[...this.logOpt],t.annotation=[...this.annotation],t.ulimit=[...this.ulimit],t.sysctl=[...this.sysctl],t.secret=[...this.secret],t}}class f{static generateFile(t,e={}){const{name:i=t.getDefaultName(),unit:s=null,service:r=null,install:a=null,globals:o=null}=e;let n="";return s&&(n+=this.generateUnitSection(s)+`
`),n+=this.generateContainerSection(t),o&&o.podmanArgs&&(n+=`
[GlobalArgs]
PodmanArgs=${o.podmanArgs}
`),r&&(n+=`
`+this.generateServiceSection(r)),a&&(n+=`
`+this.generateInstallSection(a)),n}static generateContainerSection(t){let e=`[Container]
`;return e+=`Image=${t.image}
`,t.containerName&&(e+=`ContainerName=${t.containerName}
`),t.exec&&(e+=`Exec=${t.exec}
`),t.publishPort.forEach(i=>{e+=`PublishPort=${i}
`}),t.volume.forEach(i=>{e+=`Volume=${i}
`}),t.environment.forEach(i=>{e+=`Environment=${this.escapeValue(i)}
`}),t.environmentFile.forEach(i=>{e+=`EnvironmentFile=${i}
`}),t.environmentHost&&(e+=`EnvironmentHost=true
`),t.label.forEach(i=>{e+=`Label=${this.escapeValue(i)}
`}),t.network.forEach(i=>{e+=`Network=${i}
`}),t.networkAlias.forEach(i=>{e+=`NetworkAlias=${i}
`}),t.addCapability.length>0&&(e+=`AddCapability=${t.addCapability.join(" ")}
`),t.dropCapability.length>0&&(e+=`DropCapability=${t.dropCapability.join(" ")}
`),t.dns.length>0&&(t.dns.includes("none")?e+=`DNS=none
`:t.dns.forEach(i=>{e+=`DNS=${i}
`})),t.dnsOption.forEach(i=>{e+=`DNSOption=${i}
`}),t.dnsSearch.forEach(i=>{e+=`DNSSearch=${i}
`}),t.noNewPrivileges&&(e+=`NoNewPrivileges=true
`),t.securityLabelDisable&&(e+=`SecurityLabelDisable=true
`),t.securityLabelFileType&&(e+=`SecurityLabelFileType=${t.securityLabelFileType}
`),t.securityLabelLevel&&(e+=`SecurityLabelLevel=${t.securityLabelLevel}
`),t.securityLabelNested&&(e+=`SecurityLabelNested=true
`),t.securityLabelType&&(e+=`SecurityLabelType=${t.securityLabelType}
`),t.seccompProfile&&(e+=`SeccompProfile=${t.seccompProfile}
`),t.mask.length>0&&(e+=`Mask=${t.mask.join(":")}
`),t.unmask&&(Array.isArray(t.unmask)?e+=`Unmask=${t.unmask.join(":")}
`:e+=`Unmask=${t.unmask}
`),t.user&&(e+=`User=${t.user}
`),t.group&&(e+=`Group=${t.group}
`),t.groupAdd.forEach(i=>{e+=`GroupAdd=${i}
`}),t.userNS&&(e+=`UserNS=${t.userNS}
`),t.uidMap.forEach(i=>{e+=`UIDMap=${i}
`}),t.gidMap.forEach(i=>{e+=`GIDMap=${i}
`}),t.subUidMap&&(e+=`SubUIDMap=${t.subUidMap}
`),t.subGidMap&&(e+=`SubGIDMap=${t.subGidMap}
`),t.readOnly&&(e+=`ReadOnly=true
`),t.readOnlyTmpfs||(e+=`ReadOnlyTmpfs=false
`),t.runInit&&(e+=`RunInit=true
`),t.workingDir&&(e+=`WorkingDir=${t.workingDir}
`),t.hostName&&(e+=`HostName=${t.hostName}
`),t.timezone&&(e+=`Timezone=${t.timezone}
`),t.shmSize&&(e+=`ShmSize=${t.shmSize}
`),t.tmpfs.forEach(i=>{e+=`Tmpfs=${i}
`}),t.healthCmd&&(e+=`HealthCmd=${t.healthCmd}
`),t.healthInterval&&(e+=`HealthInterval=${t.healthInterval}
`),t.healthOnFailure&&(e+=`HealthOnFailure=${t.healthOnFailure}
`),t.healthRetries&&(e+=`HealthRetries=${t.healthRetries}
`),t.healthStartPeriod&&(e+=`HealthStartPeriod=${t.healthStartPeriod}
`),t.healthTimeout&&(e+=`HealthTimeout=${t.healthTimeout}
`),t.healthStartupCmd&&(e+=`HealthStartupCmd=${t.healthStartupCmd}
`),t.healthStartupInterval&&(e+=`HealthStartupInterval=${t.healthStartupInterval}
`),t.healthStartupRetries&&(e+=`HealthStartupRetries=${t.healthStartupRetries}
`),t.healthStartupSuccess&&(e+=`HealthStartupSuccess=${t.healthStartupSuccess}
`),t.healthStartupTimeout&&(e+=`HealthStartupTimeout=${t.healthStartupTimeout}
`),t.notify&&t.notify!=="conmon"&&(t.notify==="container"?e+=`Notify=true
`:t.notify==="healthy"&&(e+=`Notify=healthy
`)),t.stopSignal&&(e+=`StopSignal=${t.stopSignal}
`),t.stopTimeout&&(e+=`StopTimeout=${t.stopTimeout}
`),t.pod&&(e+=`Pod=${t.pod}
`),t.logDriver&&(e+=`LogDriver=${t.logDriver}
`),t.logOpt.forEach(i=>{e+=`LogOpt=${i}
`}),t.annotation.forEach(i=>{e+=`Annotation=${this.escapeValue(i)}
`}),t.pidsLimit&&(e+=`PidsLimit=${t.pidsLimit}
`),t.ulimit.forEach(i=>{e+=`Ulimit=${i}
`}),t.sysctl.forEach(i=>{e+=`Sysctl=${i}
`}),t.autoUpdate&&(e+=`AutoUpdate=${t.autoUpdate}
`),t.pull&&(e+=`Pull=${t.pull}
`),t.secret.forEach(i=>{e+=`Secret=${i}
`}),t.rootfs&&(e+=`Rootfs=${t.rootfs}
`),t.entrypoint&&(e+=`Entrypoint=${t.entrypoint}
`),t.ip&&(e+=`IP=${t.ip}
`),t.ip6&&(e+=`IP6=${t.ip6}
`),t.podmanArgs&&(e+=`PodmanArgs=${t.podmanArgs}
`),e}static generateUnitSection(t){let e=`[Unit]
`;return(t.description||t.Description)&&(e+=`Description=${t.description||t.Description}
`),t.wants&&t.wants.length>0&&(e+=`Wants=${t.wants.join(" ")}
`),t.requires&&t.requires.length>0&&(e+=`Requires=${t.requires.join(" ")}
`),t.after&&t.after.length>0&&(e+=`After=${t.after.join(" ")}
`),t.before&&t.before.length>0&&(e+=`Before=${t.before.join(" ")}
`),e}static generateServiceSection(t){let e=`[Service]
`;return(t.restart||t.Restart)&&(e+=`Restart=${t.restart||t.Restart}
`),(t.restartSec||t.RestartSec)&&(e+=`RestartSec=${t.restartSec||t.RestartSec}
`),(t.timeoutStartSec||t.TimeoutStartSec)&&(e+=`TimeoutStartSec=${t.timeoutStartSec||t.TimeoutStartSec}
`),e}static generateInstallSection(t){let e=`[Install]
`;return t.wantedBy&&t.wantedBy.length>0&&(e+=`WantedBy=${t.wantedBy.join(" ")}
`),t.requiredBy&&t.requiredBy.length>0&&(e+=`RequiredBy=${t.requiredBy.join(" ")}
`),e}static escapeValue(t){return typeof t=="string"&&t.includes(" ")?`"${t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:t}}class c{constructor(){this.supportedFeatures=this._initializeSupportedFeatures()}parse(t){const e=m.parse(t);if(!e||typeof e!="object")throw new Error("Invalid compose file format");this._validateCompose(e);const i={};if(e.services)for(const[s,r]of Object.entries(e.services))i[s]=this._parseService(s,r,e);return i}async parseFile(t){const i=await(await d(()=>import("./index-f4175613.js").then(s=>s.i),["assets/index-f4175613.js","assets/index-0c1fde36.js","assets/index-290a8ba3.css","assets/empty-d0adf2b0.js","assets/empty-c5f13335.js","assets/constants-8338daba.js","assets/index-fdbe2ce9.js","assets/string_decoder-8ac4312e.js","assets/index-649b5bab.js","assets/index-a6f01dde.js","assets/inherits_browser-6f38ab1b.js","assets/index-0397ab6f.js","assets/assert-53be9de1.js","assets/index-b4fd5f8c.js","assets/index-cfd4d427.js"])).default.readFile(t,"utf8");return this.parse(i)}_parseService(t,e,i){const s=new h;if(e.image)s.setImage(e.image);else if(e.build)s.setImage(`${t}.build`);else throw new Error(`Service '${t}' must have either 'image' or 'build'`);if(e.container_name?s.setContainerName(e.container_name):s.setContainerName(t),e.command){const r=Array.isArray(e.command)?e.command.join(" "):e.command;s.setExec(r)}if(e.entrypoint){const r=Array.isArray(e.entrypoint)?e.entrypoint.join(" "):e.entrypoint;s.entrypoint=r}if(e.ports&&this._parsePorts(e.ports,s),e.volumes&&this._parseVolumes(e.volumes,s,i.volumes),e.environment&&this._parseEnvironment(e.environment,s),e.env_file&&(Array.isArray(e.env_file)?e.env_file:[e.env_file]).forEach(a=>s.environmentFile.push(a)),e.labels&&this._parseLabels(e.labels,s),e.networks&&this._parseNetworks(e.networks,s),e.hostname&&(s.hostName=e.hostname),e.user){const r=String(e.user);if(r.includes(":")){const[a,o]=r.split(":");s.user=a,s.group=o}else s.user=r}if(e.working_dir&&(s.workingDir=e.working_dir),e.restart&&(s._restart=e.restart),e.security_opt&&this._parseSecurityOptions(e.security_opt,s),e.cap_add){const r=Array.isArray(e.cap_add)?e.cap_add:[e.cap_add];s.addCapability.push(...r)}if(e.cap_drop){const r=Array.isArray(e.cap_drop)?e.cap_drop:[e.cap_drop];s.dropCapability.push(...r)}if(e.devices){const r=Array.isArray(e.devices)?e.devices:[e.devices];s.addDevice.push(...r)}if(e.dns){const r=Array.isArray(e.dns)?e.dns:[e.dns];s.dns.push(...r)}if(e.read_only&&(s.readOnly=!0),e.init&&(s.runInit=!0),e.tmpfs){const r=Array.isArray(e.tmpfs)?e.tmpfs:[e.tmpfs];s.tmpfs.push(...r)}return e.privileged&&this._addToPodmanArgs(s,"--privileged"),e.tty&&this._addToPodmanArgs(s,"--tty"),e.stdin_open&&this._addToPodmanArgs(s,"--interactive"),e.mem_limit&&this._addToPodmanArgs(s,"--memory",e.mem_limit),e.cpus&&this._addToPodmanArgs(s,"--cpus",String(e.cpus)),e.healthcheck&&this._parseHealthcheck(e.healthcheck,s),e.depends_on&&(s._dependsOn=Array.isArray(e.depends_on)?e.depends_on:Object.keys(e.depends_on)),s}_parsePorts(t,e){const i=Array.isArray(t)?t:[t];for(const s of i)if(typeof s=="string"||typeof s=="number")e.addPublishPort(String(s));else if(typeof s=="object"){let r="";s.published&&(r+=s.published+":"),r+=s.target,s.protocol&&s.protocol!=="tcp"&&(r+="/"+s.protocol),e.addPublishPort(r)}}_parseVolumes(t,e,i={}){const s=Array.isArray(t)?t:[t];for(const r of s)if(typeof r=="string")e.addVolume(r);else if(typeof r=="object"){let a="";if(r.type==="tmpfs"){let o=r.target;r.tmpfs&&r.tmpfs.size&&(o+=":size="+r.tmpfs.size),e.tmpfs.push(o);continue}r.source&&(a+=r.source+":"),a+=r.target,r.read_only&&(a+=":ro"),e.addVolume(a)}}_parseEnvironment(t,e){if(Array.isArray(t))t.forEach(i=>e.addEnvironment(i));else if(typeof t=="object")for(const[i,s]of Object.entries(t))e.addEnvironment(`${i}=${s}`)}_parseLabels(t,e){if(Array.isArray(t))t.forEach(i=>e.addLabel(i));else if(typeof t=="object")for(const[i,s]of Object.entries(t))e.addLabel(`${i}=${s}`)}_parseNetworks(t,e){if(Array.isArray(t))t.forEach(i=>{typeof i=="string"&&e.network.push(i)});else if(typeof t=="object")for(const[i,s]of Object.entries(t)){let r=i;if(s&&typeof s=="object"){const a=[];s.ipv4_address&&a.push(`ip=${s.ipv4_address}`),s.aliases&&s.aliases.length>0&&s.aliases.forEach(o=>{e.networkAlias.push(o)}),a.length>0&&(r+=":"+a.join(","))}e.network.push(r)}}_parseSecurityOptions(t,e){const i=Array.isArray(t)?t:[t];for(const s of i)s==="no-new-privileges:true"?e.noNewPrivileges=!0:s.startsWith("label=disable")?e.securityLabelDisable=!0:this._addToPodmanArgs(e,"--security-opt",s)}_parseHealthcheck(t,e){if(t.disable){e.healthCmd="none";return}if(t.test){const i=Array.isArray(t.test)?t.test.join(" "):t.test;e.healthCmd=i}t.interval&&(e.healthInterval=t.interval),t.timeout&&(e.healthTimeout=t.timeout),t.retries&&(e.healthRetries=t.retries),t.start_period&&(e.healthStartPeriod=t.start_period)}_addToPodmanArgs(t,e,i=null){let s=t.podmanArgs||"";s&&(s+=" "),s+=e,i!==null&&(s+=" "+this._escapeArg(i)),t.podmanArgs=s}_escapeArg(t){return typeof t!="string"&&(t=String(t)),/[\s"'`$\\|&;()<>]/.test(t)?`"${t.replace(/["\\]/g,"\\$&")}"`:t}_validateCompose(t){if(!t.services||Object.keys(t.services).length===0)throw new Error("Compose file must contain at least one service");const e=["configs","secrets"];for(const i of e)if(t[i]&&Object.keys(t[i]).length>0)throw new Error(`Compose feature '${i}' is not yet supported`);for(const[i,s]of Object.entries(t.services))this._validateService(i,s)}_validateService(t,e){if(!e.image&&!e.build)throw new Error(`Service '${t}' must have either 'image' or 'build'`);const i=["external_links","links","network_mode","secrets","configs","deploy"];for(const s of i)e[s]&&console.warn(`Warning: Service '${t}' uses unsupported feature '${s}' - ignoring`)}_initializeSupportedFeatures(){return{services:!0,volumes:!0,networks:!0,version:!0,name:!0,configs:!1,secrets:!1,extensions:!1}}}class w{constructor(){this.composeParser=new c,this.quadletGenerator=new f}dockerRunToQuadlet(t,e={}){const i=this.parseDockerRun(t),s=Object.keys(i.services)[0],r=i.services[s],a=this.composeParser._parseService(s,r,i);return this.containerToQuadlet(a,e)}composeToQuadlet(t,e={}){const i=this.composeParser.parse(t),s=[];for(const[r,a]of Object.entries(i)){let o=e.unit||{};a._dependsOn&&a._dependsOn.length>0&&(o={...o,after:[...o.after||[],...a._dependsOn.map(l=>`${l}.service`)],wants:[...o.wants||[],...a._dependsOn.map(l=>`${l}.service`)]});let n=e.service||{};if(a._restart){const u={no:"no",always:"always","on-failure":"on-failure","unless-stopped":"unless-stopped"}[a._restart];u!==void 0&&(n={...n,Restart:u})}const y=this.containerToQuadlet(a,{...e,name:r,unit:Object.keys(o).length>0?o:e.unit,service:Object.keys(n).length>0?n:e.service});s.push({filename:`${r}.container`,content:y})}return s}containerToQuadlet(t,e={}){return t.validate(),f.generateFile(t,e)}parseDockerRun(t){Array.isArray(t)&&(t=t.join(" "));const e=g(t);return m.parse(e)}parseCompose(t){const e=this.composeParser.parse(t);return Object.values(e)}fromDockerRun(t,e={}){return this.dockerRunToQuadlet(t,e)}async fromCompose(t,e={}){const s=await(await d(()=>import("./index-f4175613.js").then(r=>r.i),["assets/index-f4175613.js","assets/index-0c1fde36.js","assets/index-290a8ba3.css","assets/empty-d0adf2b0.js","assets/empty-c5f13335.js","assets/constants-8338daba.js","assets/index-fdbe2ce9.js","assets/string_decoder-8ac4312e.js","assets/index-649b5bab.js","assets/index-a6f01dde.js","assets/inherits_browser-6f38ab1b.js","assets/index-0397ab6f.js","assets/assert-53be9de1.js","assets/index-b4fd5f8c.js","assets/index-cfd4d427.js"])).readFile(t,"utf8");return this.composeToQuadlet(s,e)}}export{w as P};
