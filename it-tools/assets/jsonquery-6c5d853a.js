const k=n=>Array.isArray(n),tn=n=>n!==null&&typeof n=="object"&&!k(n),en=n=>typeof n=="string",E=(n,t)=>n===t?!0:n!==null&&t!==null&&typeof n=="object"&&typeof t=="object"&&Object.keys(n).length===Object.keys(t).length&&Object.entries(n).every(([e,r])=>E(r,t[e])),C=(n,t)=>{const e=n?.[t];if(e!==void 0){if(!Object.hasOwn(n,t)||Array.isArray(n)&&!/^\d+$/.test(t)||typeof n!="object")throw new TypeError(`Unsupported property "${t}"`);return e}};function d(n){return(...t)=>{const e=t.map(s=>g(s)),r=e[0],o=e[1];return e.length===1?s=>n(r(s)):e.length===2?s=>n(r(s),o(s)):s=>n(...e.map(y=>y(s)))}}const B={boolean:0,number:1,string:2},F=3,H=(n,t)=>typeof n==typeof t&&typeof n in B?n>t:!1,rn=(n,t)=>E(n,t)||H(n,t),Q=(n,t)=>typeof n==typeof t&&typeof n in B?n<t:!1,on=(n,t)=>E(n,t)||Q(n,t),_={pipe:(...n)=>{const t=n.map(e=>g(e));return e=>t.reduce((r,o)=>o(r),e)},object:n=>{const t=Object.keys(n).map(e=>[e,g(n[e])]);return e=>{const r={};for(const[o,s]of t)r[o]=s(e);return r}},array:(...n)=>{const t=n.map(e=>g(e));return e=>t.map(r=>r(e))},get:(...n)=>{if(n.length===0)return t=>t??null;if(n.length===1){const t=n[0];return e=>C(e,t)??null}return t=>{let e=t;for(const r of n)e=C(e,r);return e??null}},map:n=>{const t=g(n);return e=>e.map(t)},mapObject:n=>{const t=g(n);return e=>{const r={};for(const o of Object.keys(e)){const s=t({key:o,value:e[o]});r[s.key]=s.value}return r}},mapKeys:n=>{const t=g(n);return e=>{const r={};for(const o of Object.keys(e)){const s=t(o);r[s]=e[o]}return r}},mapValues:n=>{const t=g(n);return e=>{const r={};for(const o of Object.keys(e))r[o]=t(e[o]);return r}},filter:n=>{const t=g(n);return e=>e.filter(r=>G(t(r)))},sort:(n=["get"],t)=>{const e=g(n),r=t==="desc"?-1:1;function o(s,y){const i=e(s),v=e(y);if(typeof i!=typeof v){const I=B[typeof i]??F,A=B[typeof v]??F;return I>A?r:I<A?-r:0}return typeof i in B?i>v?r:i<v?-r:0:0}return s=>s.slice().sort(o)},reverse:()=>n=>n.toReversed(),pick:(...n)=>{const t=n.map(([r,...o])=>[o[o.length-1],_.get(...o)]),e=(r,o)=>{const s={};for(const[y,i]of o)s[y]=i(r);return s};return r=>k(r)?r.map(o=>e(o,t)):e(r,t)},groupBy:n=>{const t=g(n);return e=>{const r={};for(const o of e){const s=t(o);r[s]?r[s].push(o):r[s]=[o]}return r}},keyBy:n=>{const t=g(n);return e=>{const r={};for(const o of e){const s=t(o);s in r||(r[s]=o)}return r}},flatten:()=>n=>n.flat(),join:(n="")=>t=>t.join(n),split:d((n,t)=>t!==void 0?n.split(t):n.trim().split(/\s+/)),substring:d((n,t,e)=>n.slice(Math.max(t,0),e)),uniq:()=>n=>{const t=[];for(const e of n)t.findIndex(r=>E(r,e))===-1&&t.push(e);return t},uniqBy:n=>t=>Object.values(_.keyBy(n)(t)),limit:n=>t=>t.slice(0,Math.max(n,0)),size:()=>n=>n.length,keys:()=>Object.keys,values:()=>Object.values,prod:()=>n=>z(n,(t,e)=>t*e),sum:()=>n=>k(n)?n.reduce((t,e)=>t+e,0):K(),average:()=>n=>k(n)?n.length>0?n.reduce((t,e)=>t+e)/n.length:null:K(),min:()=>n=>z(n,(t,e)=>Math.min(t,e)),max:()=>n=>z(n,(t,e)=>Math.max(t,e)),and:d((...n)=>z(n,(t,e)=>!!(t&&e))),or:d((...n)=>z(n,(t,e)=>!!(t||e))),not:d(n=>!n),exists:n=>{const t=n.slice(1),e=t.pop(),r=_.get(...t);return o=>{const s=r(o);return!!s&&Object.hasOwnProperty.call(s,e)}},if:(n,t,e)=>{const r=g(n),o=g(t),s=g(e);return y=>G(r(y))?o(y):s(y)},in:(n,t)=>{const e=g(n),r=g(t);return o=>{const s=e(o);return r(o).findIndex(y=>E(y,s))!==-1}},"not in":(n,t)=>{const e=_.in(n,t);return r=>!e(r)},regex:(n,t,e)=>{const r=new RegExp(t,e),o=g(n);return s=>r.test(o(s))},match:(n,t,e)=>{const r=new RegExp(t,e),o=g(n);return s=>{const y=o(s).match(r);return y?D(y):null}},matchAll:(n,t,e)=>{const r=new RegExp(t,`${e??""}g`),o=g(n);return s=>Array.from(o(s).matchAll(r)).map(D)},eq:d(E),gt:d(H),gte:d(rn),lt:d(Q),lte:d(on),ne:d((n,t)=>!E(n,t)),add:d((n,t)=>n+t),subtract:d((n,t)=>n-t),multiply:d((n,t)=>n*t),divide:d((n,t)=>n/t),mod:d((n,t)=>n%t),pow:d((n,t)=>n**t),abs:d(Math.abs),round:d((n,t=0)=>+`${Math.round(+`${n}e${t}`)}e${-t}`),number:d(n=>{const t=Number(n);return Number.isNaN(Number(n))?null:t}),string:d(String)},G=n=>n!==null&&n!==0&&n!==!1,z=(n,t)=>(k(n)||K(),n.length===0?null:n.reduce(t)),D=n=>{const[t,...e]=n,r=n.groups;return e.length?r?{value:t,groups:e,namedGroups:r}:{value:t,groups:e}:{value:t}},K=()=>{L("Array expected")},L=n=>{throw new TypeError(n)},Z=[];function g(n,t){Z.unshift({..._,...Z[0],...t?.functions});try{const e=k(n)?sn(n,Z[0]):tn(n)?L(`Function notation ["object", {...}] expected but got ${JSON.stringify(n)}`):()=>n;return r=>{try{return e(r)}catch(o){throw o.jsonquery=[{data:r,query:n},...o.jsonquery??[]],o}}}finally{Z.shift()}}function sn(n,t){const[e,...r]=n,o=t[e];return o||L(`Unknown function '${e}'`),o(...r)}const W=[{pow:"^"},{multiply:"*",divide:"/",mod:"%"},{add:"+",subtract:"-"},{gt:">",gte:">=",lt:"<",lte:"<=",in:"in","not in":"not in"},{eq:"==",ne:"!="},{and:"and"},{or:"or"},{pipe:"|"}],cn=["|","and","or"],X=["|","and","or","*","/","%","+","-"];function Y(n,t){if(!k(t))throw new Error("Invalid custom operators");return t.reduce(un,n)}function un(n,{name:t,op:e,at:r,after:o,before:s}){if(r)return n.map(v=>Object.values(v).includes(r)?{...v,[t]:e}:v);const y=o??s,i=n.findIndex(v=>Object.values(v).includes(y));if(i!==-1)return n.toSpliced(i+(o?1:0),0,{[t]:e});throw new Error("Invalid custom operator")}const ln=/^[a-zA-Z_$][a-zA-Z\d_$]*$/,an=/^[a-zA-Z_$][a-zA-Z\d_$]*/,pn=/^"(?:[^"\\]|\\.)*"/,fn=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?/,dn=/^(0|[1-9][0-9]*)/,gn=/^(true|false|null)/,yn=/^[ \n\t\r]+/;function hn(n,t){const e=t?.operators??[],r=Y(W,e),o=Object.assign({},...r),s=cn.concat(e.filter(c=>c.vararg).map(c=>c.op)),y=X.concat(e.filter(c=>c.leftAssociative).map(c=>c.op)),i=(c=r.length-1)=>{const f=r[c];if(!f)return I();const h=n[u]==="(";let m=i(c-1);for(;;){if(p(),n[u]==="."&&"pipe"in f){const V=A();m=m[0]==="pipe"?[...m,V]:["pipe",m,V];continue}const q=u,M=v(f);if(!M)break;const P=i(c-1),nn=m[0],T=M===nn&&!h;if(T&&!y.includes(o[M])){u=q;break}m=T&&s.includes(o[M])?[...m,P]:[M,m,P]}return m},v=c=>{const f=Object.keys(c).sort((h,m)=>m.length-h.length);for(const h of f){const m=c[h];if(n.substring(u,u+m.length)===m)return u+=m.length,p(),h}},I=()=>{if(p(),n[u]==="("){u++;const c=i();return O(")"),c}return A()},A=()=>{if(n[u]==="."){const c=[];for(;n[u]===".";)u++,c.push(l()??b()??j()??S("Property expected")),p();return["get",...c]}return R()},R=()=>{const c=u,f=b();if(p(),!f||n[u]!=="(")return u=c,J();u++,p();const h=n[u]!==")"?[i()]:[];for(;u<n.length&&n[u]!==")";)p(),O(","),h.push(i());return O(")"),[f,...h]},J=()=>{if(n[u]==="{"){u++,p();const c={};let f=!0;for(;u<n.length&&n[u]!=="}";){f?f=!1:(O(","),p());const h=l()??b()??j()??S("Key expected");p(),O(":"),c[h]=i()}return O("}"),["object",c]}return a()},a=()=>{if(n[u]==="["){u++,p();const c=[];let f=!0;for(;u<n.length&&n[u]!=="]";)f?f=!1:(O(","),p()),c.push(i());return O("]"),["array",...c]}return l()??$()??x()},l=()=>w(pn,JSON.parse),b=()=>w(an,c=>c),$=()=>w(fn,JSON.parse),j=()=>w(dn,JSON.parse),x=()=>{const c=w(gn,JSON.parse);if(c!==void 0)return c;S("Value expected")},N=()=>{p(),u<n.length&&S(`Unexpected part '${n.substring(u)}'`)},w=(c,f)=>{const h=n.substring(u).match(c);if(h)return u+=h[0].length,f(h[0])},p=()=>w(yn,c=>c),O=c=>{n[u]!==c&&S(`Character '${c}' expected`),u++},S=(c,f=u)=>{throw new SyntaxError(`${c} (pos: ${f})`)};let u=0;const U=i();return N(),U}const mn=40,bn="  ",$n=(n,t)=>{const e=t?.indentation??bn,r=t?.operators??[],o=Y(W,r),s=Object.assign({},...o),y=X.concat(r.filter(a=>a.leftAssociative).map(a=>a.op)),i=(a,l,b=!1)=>k(a)?v(a,l,b):JSON.stringify(a),v=(a,l,b)=>{const[$,...j]=a;if($==="get"&&j.length>0)return A(j);if($==="object")return I(j[0],l);if($==="array"){const p=j.map(O=>i(O,l));return J(p,["[",", ","]"],[`[
${l+e}`,`,
${l+e}`,`
${l}]`])}const x=s[$];if(x){const p=b?"(":"",O=b?")":"",S=j.map((u,U)=>{const c=u?.[0],f=o.findIndex(q=>$ in q),h=o.findIndex(q=>c in q),m=f<h||f===h&&U>0||$===c&&!y.includes(x);return i(u,l+e,m)});return J(S,[p,` ${x} `,O],[p,`
${l+e}${x} `,O])}const N=j.length===1?l:l+e,w=j.map(p=>i(p,N));return J(w,[`${$}(`,", ",")"],j.length===1?[`${$}(`,`,
${l}`,")"]:[`${$}(
${N}`,`,
${N}`,`
${l})`])},I=(a,l)=>{const b=l+e,$=Object.entries(a).map(([j,x])=>`${R(j)}: ${i(x,b)}`);return J($,["{ ",", "," }"],[`{
${b}`,`,
${b}`,`
${l}}`])},A=a=>a.map(l=>`.${R(l)}`).join(""),R=a=>ln.test(a)?a:JSON.stringify(a),J=(a,[l,b,$],[j,x,N])=>l.length+a.reduce((w,p)=>w+p.length+b.length,0)-b.length+$.length<=(t?.maxLineLength??mn)?l+a.join(b)+$:j+a.join(x)+N;return i(n,"")};function jn(n,t,e){return g(en(t)?hn(t,e):t,e)(n)}export{$n as O,jn as b,hn as m};
